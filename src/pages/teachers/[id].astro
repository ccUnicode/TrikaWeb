---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import TeacherRatingForm from "../../components/TeacherRatingForm.astro";
import TeacherAvatar from "../../components/TeacherAvatar.astro";
import { getTeacherDetail } from "../../lib/data";

const teacherId = Number(Astro.params.id);
const page = Number(Astro.url.searchParams.get("page") ?? 1);
const pageSize = Number(Astro.url.searchParams.get("pageSize") ?? 5);

if (!teacherId) {
  return Astro.redirect("/teachers");
}

const detail = await getTeacherDetail(teacherId, page, pageSize);

if (!detail) {
  return Astro.redirect("/teachers");
}

const statsItems = [
  { label: "Didáctica", value: detail.stats.avg_didactic },
  { label: "Dificultad", value: detail.stats.avg_difficulty },
  { label: "Material", value: detail.stats.avg_resources },
  { label: "Responsabilidad", value: detail.stats.avg_responsability },
  { label: "Calif. justa", value: detail.stats.avg_grading },
];

const formatScore = (n: number | null) =>
  n === null || n === undefined ? "—" : Number(n).toFixed(1);

const formatDate = (iso: string) => {
  const date = new Date(iso);
  if (Number.isNaN(date.getTime())) return "Fecha desconocida";
  return date.toLocaleDateString("es-PE", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
};

const getBarColor = (value: number | null): string => {
  if (value === null || value === undefined) return "#6B7280"; // Gray for null
  if (value <= 2.0) return "#EF4444"; // Red - Malo
  if (value <= 3.0) return "#F97316"; // Orange - Regular
  if (value <= 4.0) return "#EAB308"; // Yellow - Bueno
  return "#22C55E"; // Green - Excelente
};

const safeBio =
  detail.teacher.bio && detail.teacher.bio.trim().length > 0
    ? detail.teacher.bio
    : "Sin descripción disponible.";

const toAvatarUrl = (src?: string | null) => {
  const fallback = "/img/fallback_teacher.jpeg";
  const cleanSrc = (src || "").trim();
  if (!cleanSrc) return fallback;
  if (cleanSrc.startsWith("http")) return cleanSrc;
  const base = import.meta.env.PUBLIC_SUPABASE_URL;
  if (!base) return fallback;
  const clean = cleanSrc.replace(/^\/+/, "");
  return `${base}/storage/v1/object/public/avatars/${clean}`;
};
const avatarUrl = toAvatarUrl(detail.teacher.avatar_url);
---

<Layout title={`Profesor ${detail.teacher.full_name}`}>
  <main class="mx-auto max-w-7xl px-2 sm:px-4 py-10 text-global-text">
    <!-- Contenedor principal con fondo #171A1F -->
    <div
      class="rounded-3xl p-4 sm:p-10 shadow-2xl"
      style="background-color: #171A1F;"
    >
      <div class="grid gap-6 lg:grid-cols-3">
        <!-- Columna izquierda: avatar, nombre, score y CTA -->
        <section
          class="rounded-3xl bg-global-card border border-global-border-subtle p-6 flex flex-col gap-6 shadow-lg"
        >
          <div class="flex flex-col items-center gap-6">
            <TeacherAvatar
              name={detail.teacher.full_name}
              avatarSrc={detail.teacher.avatar_url}
              size="lg"
            />
            <div
              class="w-full rounded-2xl border border-global-border-subtle px-4 py-3 text-center"
              style="background-color: #2A3240;"
            >
              <p class="text-lg font-semibold">{detail.teacher.full_name}</p>
            </div>
          </div>
          <div
            class="flex items-center justify-between bg-global-bg/60 rounded-2xl px-4 py-3"
          >
            <div class="text-sm text-global-text-muted leading-tight">
              <p>Puntuacion</p>
              <p>General</p>
            </div>
            <div class="text-right">
              <p class="text-4xl font-bold">
                {formatScore(detail.teacher.avg_overall)}
              </p>
              <p class="text-xs text-global-text-muted mt-1">
                {detail.teacher.rating_count} resenas
              </p>
            </div>
          </div>
          <button
            id="open-rating-modal"
            type="button"
            class="rounded-2xl bg-global-primary text-black font-semibold text-center py-3 hover:bg-global-primary-hover transition"
          >
            Califica al profesor
          </button>
        </section>

        <!-- Columna centro: descripción y estadísticas -->
        <section
          class="rounded-3xl bg-global-card border border-global-border-subtle p-6 space-y-6 shadow-lg"
        >
          <div class="space-y-3">
            <h2 class="text-2xl font-semibold">Descripción</h2>
            <p
              class="text-global-text-muted leading-relaxed max-h-40 overflow-y-auto pr-1 teacher-scroll text-justify-bio"
            >
              {safeBio}
            </p>
          </div>
          <div class="space-y-4">
            <h3 class="text-2xl font-semibold">Estadísticas</h3>
            <div class="space-y-3">
              {
                statsItems.map((item) => (
                  <div class="flex items-center gap-3">
                    <span class="min-w-[120px]">{item.label}</span>
                    <div
                      class="flex-1 h-8 rounded-md border border-global-border-subtle relative overflow-hidden"
                      style="background-color: rgba(42, 50, 64, 0.3);"
                    >
                      {item.value !== null ? (
                        <div
                          class="absolute inset-y-0 left-0"
                          style={{
                            width: `${Math.min(100, (item.value / 5) * 100)}%`,
                            backgroundColor: "#2A3240",
                          }}
                        />
                      ) : null}
                      <span class="absolute right-2 top-1/2 -translate-y-1/2 text-sm font-semibold">
                        {formatScore(item.value)}
                      </span>
                    </div>
                  </div>
                ))
              }
            </div>
          </div>
        </section>

        <!-- Columna derecha: cursos y comentarios -->
        <section
          class="rounded-3xl bg-global-card border border-global-border-subtle p-6 space-y-6 shadow-lg"
        >
          <div class="space-y-3">
            <h3 class="text-2xl font-semibold text-center">Cursos</h3>
            {
              detail.courses.length === 0 ? (
                <p class="text-center text-global-text-muted text-sm">
                  Sin cursos asociados.
                </p>
              ) : (
                <div class="flex flex-col gap-3">
                  {detail.courses.map((course) => (
                    <a
                      href={`/curso/${course.code}`}
                      class="rounded-xl border border-global-border-subtle px-4 py-2 text-center font-medium hover:border-global-primary transition"
                      style="background-color: #2A3240;"
                    >
                      {course.code} · {course.name}
                    </a>
                  ))}
                </div>
              )
            }
          </div>

          <div class="space-y-3">
            <h3 class="text-2xl font-semibold text-center">Comentarios</h3>
            {
              detail.reviews.length === 0 ? (
                <p class="text-center text-global-text-muted text-sm">
                  Sin comentarios visibles.
                </p>
              ) : (
                <div class="flex flex-col gap-3 max-h-80 overflow-y-auto pr-2 teacher-scroll">
                  {detail.reviews.map((review) => (
                    <article
                      class="rounded-xl border border-global-border-subtle px-4 py-3 space-y-2"
                      style="background-color: #2A3240;"
                    >
                      {" "}
                      <header class="flex items-center justify-between text-sm">
                        <div class="leading-tight">
                          <span class="font-semibold block">Anonimo</span>
                          <time class="text-[11px] text-global-text-muted/80">
                            {formatDate(review.created_at)}
                          </time>
                        </div>
                        <span class="text-global-text-muted font-semibold">
                          {formatScore(review.overall)}
                        </span>
                      </header>
                      {review.comment && (
                        <p class="text-sm text-global-text-muted leading-relaxed text-justify max-h-24 overflow-y-auto teacher-scroll pr-1">
                          {review.comment}
                        </p>
                      )}
                    </article>
                  ))}
                </div>
              )
            }
            {
              detail.pagination.totalPages > 1 && (
                <div class="flex items-center justify-between text-sm text-global-text-muted">
                  <a
                    class={`px-3 py-2 rounded-lg border ${page > 1 ? "border-global-border hover:border-global-primary" : "border-transparent opacity-50 pointer-events-none"}`}
                    href={`/teachers/${teacherId}?page=${Math.max(1, page - 1)}&pageSize=${pageSize}`}
                  >
                    ← Anterior
                  </a>
                  <span>
                    Página {page} de {detail.pagination.totalPages}
                  </span>
                  <a
                    class={`px-3 py-2 rounded-lg border ${page < detail.pagination.totalPages ? "border-global-border hover:border-global-primary" : "border-transparent opacity-50 pointer-events-none"}`}
                    href={`/teachers/${teacherId}?page=${Math.min(detail.pagination.totalPages, page + 1)}&pageSize=${pageSize}`}
                  >
                    Siguiente →
                  </a>
                </div>
              )
            }
          </div>
        </section>
      </div>
    </div>
  </main>
</Layout>

<div
  id="rating-modal"
  class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/60 backdrop-blur-sm"
>
  <div
    class="rating-modal relative w-full max-w-4xl mx-4 rounded-3xl bg-global-card p-6 sm:p-8 shadow-2xl animate-fade-in"
  >
    <button
      type="button"
      id="close-rating-modal"
      class="absolute right-5 top-5 text-2xl text-global-text-muted hover:text-global-primary transition-colors"
      aria-label="Cerrar"
    >
      ✕
    </button>
    <h3 class="text-2xl font-semibold mb-8 truncate pr-10">
      Calificar a {detail.teacher.full_name}
    </h3>
    <TeacherRatingForm
      teacherId={detail.teacher.id}
      avg={detail.teacher.avg_overall}
      count={detail.teacher.rating_count}
      showSummary={false}
    />
  </div>
</div>

<style>
  /* Fuerza el formulario abierto dentro del modal y oculta el toggle interno */
  .rating-modal [data-toggle-form],
  .rating-modal .teacher-rating > div:first-child {
    display: none !important;
  }
  .rating-modal [data-rating-form] {
    display: block !important;
  }
  .rating-modal .teacher-rating {
    /* Mantener el borde del card pero quitar padding y background duplicado */
    background: transparent;
    padding: 0;
  }

  /* Animación suave de aparición del modal */
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.2s ease-out;
  }
</style>

<script>
  const openBtn = document.getElementById("open-rating-modal");
  const modal = document.getElementById("rating-modal");
  const closeBtn = document.getElementById("close-rating-modal");

  const openModal = () => modal?.classList.remove("hidden");
  const closeModal = () => modal?.classList.add("hidden");

  openBtn?.addEventListener("click", openModal);
  closeBtn?.addEventListener("click", closeModal);
  modal?.addEventListener("click", (e) => {
    if (e.target === modal) closeModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });
</script>
