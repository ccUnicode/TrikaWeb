---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import TeacherRatingForm from "../../components/TeacherRatingForm.astro";
import { getTeacherDetail } from "../../lib/data";

const teacherId = Number(Astro.params.id);
const page = Number(Astro.url.searchParams.get("page") ?? 1);
const pageSize = Number(Astro.url.searchParams.get("pageSize") ?? 5);

if (!teacherId) {
  return Astro.redirect("/teachers");
}

const detail = await getTeacherDetail(teacherId, page, pageSize);

if (!detail) {
  return Astro.redirect("/teachers");
}

const statsItems = [
  { label: "Didáctica", value: detail.stats.avg_didactic },
  { label: "Dificultad", value: detail.stats.avg_difficulty },
  { label: "Material", value: detail.stats.avg_resources },
  { label: "Responsabilidad", value: detail.stats.avg_responsability },
  { label: "Calif. justa", value: detail.stats.avg_grading },
];

const formatScore = (n: number | null) =>
  n === null || n === undefined ? "—" : Number(n).toFixed(1);

const safeBio =
  detail.teacher.bio && detail.teacher.bio.trim().length > 0
    ? detail.teacher.bio
    : "Sin descripción disponible.";

const toAvatarUrl = (src?: string | null) => {
  const fallback = "/img/fallback_teacher.jpeg";
  const cleanSrc = (src || "").trim();
  if (!cleanSrc) return fallback;
  if (cleanSrc.startsWith("http")) return cleanSrc;
  const base = import.meta.env.PUBLIC_SUPABASE_URL;
  if (!base) return fallback;
  const clean = cleanSrc.replace(/^\/+/, "");
  return `${base}/storage/v1/object/public/avatars/${clean}`;
};
const avatarUrl = toAvatarUrl(detail.teacher.avatar_url);
---

<Layout title={`Profesor ${detail.teacher.full_name}`}>
  <main class="mx-auto max-w-6xl px-4 py-10 text-global-text">
    <div class="grid gap-6 lg:grid-cols-3">
      <!-- Columna izquierda: avatar, nombre, score y CTA -->
      <section class="rounded-3xl bg-global-card border border-global-border/40 p-6 flex flex-col gap-6 shadow-lg">
        <div class="flex flex-col items-center gap-6">
          <div class="h-48 w-48 sm:h-52 sm:w-52 rounded-3xl bg-global-bg border border-global-border/50 overflow-hidden">
            <img
              src={avatarUrl}
              alt={`Foto de ${detail.teacher.full_name}`}
              class="h-full w-full object-cover object-center"
              loading="lazy"
              onerror="this.onerror=null;this.src='/img/teacher.png';"
            />
          </div>
          <div class="w-full rounded-2xl bg-global-card border border-global-border/40 px-4 py-3 text-center">
            <p class="text-lg font-semibold">{detail.teacher.full_name}</p>
          </div>
        </div>
        <div class="flex items-center justify-between bg-global-bg/60 rounded-2xl px-4 py-3">
          <div class="text-sm text-global-text-muted leading-tight">
            <p>Puntuación</p>
            <p>General</p>
          </div>
          <p class="text-4xl font-bold">{formatScore(detail.teacher.avg_overall)}</p>
        </div>
        <button
          id="open-rating-modal"
          type="button"
          class="rounded-2xl bg-global-primary text-black font-semibold text-center py-3 hover:bg-global-primary-hover transition"
        >
          Califica al profesor
        </button>
      </section>

      <!-- Columna centro: descripción y estadísticas -->
      <section class="rounded-3xl bg-global-card border border-global-border/40 p-6 space-y-6 shadow-lg">
        <div class="space-y-3">
          <h2 class="text-2xl font-semibold">Descripción</h2>
          <p class="text-global-text-muted leading-relaxed max-h-40 overflow-y-auto pr-1 teacher-scroll">
            {safeBio}
          </p>
        </div>
        <div class="space-y-4">
          <h3 class="text-2xl font-semibold">Estadísticas</h3>
          <div class="space-y-3">
            {statsItems.map(item => (
              <div class="flex items-center gap-3">
                <span class="min-w-[120px]">{item.label}</span>
                <div class="flex-1 h-8 rounded-md bg-global-bg/60 border border-global-border/40 relative overflow-hidden">
                  {
                    item.value !== null ? (
                      <div
                        class="absolute inset-y-0 left-0 bg-global-primary/80"
                        style={{ width: `${Math.min(100, (item.value / 5) * 100)}%` }}
                      />
                    ) : null
                  }
                  <span class="absolute right-2 top-1/2 -translate-y-1/2 text-sm font-semibold">
                    {formatScore(item.value)}
                  </span>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      <!-- Columna derecha: cursos y comentarios -->
      <section class="rounded-3xl bg-global-card border border-global-border/40 p-6 space-y-6 shadow-lg">
        <div class="space-y-3">
          <h3 class="text-2xl font-semibold text-center">Cursos</h3>
          {
            detail.courses.length === 0 ? (
              <p class="text-center text-global-text-muted text-sm">Sin cursos asociados.</p>
            ) : (
              <div class="flex flex-col gap-3">
                {detail.courses.map(course => (
                  <a
                    href={`/curso/${course.code}`}
                    class="rounded-xl bg-global-bg/70 border border-global-border/40 px-4 py-2 text-center font-medium hover:border-global-primary transition"
                  >
                    {course.code} · {course.name}
                  </a>
                ))}
              </div>
            )
          }
        </div>

        <div class="space-y-3">
          <h3 class="text-2xl font-semibold text-center">Comentarios</h3>
          {
            detail.reviews.length === 0 ? (
              <p class="text-center text-global-text-muted text-sm">Sin comentarios visibles.</p>
            ) : (
              <div class="flex flex-col gap-3 max-h-80 overflow-y-auto pr-2 teacher-scroll">
                {detail.reviews.map(review => (
                  <article class="rounded-xl bg-global-bg/70 border border-global-border/40 px-4 py-3 space-y-2">
                    <header class="flex items-center justify-between text-sm">
                      <span class="font-semibold">Anónimo</span>
                      <span class="text-global-text-muted">{formatScore(review.overall)}</span>
                    </header>
                    {review.comment ? (
                      <p class="text-sm text-global-text-muted leading-relaxed text-justify max-h-24 overflow-y-auto teacher-scroll pr-1">
                        {review.comment}
                      </p>
                    ) : (
                      <p class="text-xs text-global-text-muted italic">Sin comentario.</p>
                    )}
                  </article>
                ))}
              </div>
            )
          }
          {
            detail.pagination.totalPages > 1 && (
              <div class="flex items-center justify-between text-sm text-global-text-muted">
                <a
                  class={`px-3 py-2 rounded-lg border ${page > 1 ? "border-global-border hover:border-global-primary" : "border-transparent opacity-50 pointer-events-none"}`}
                  href={`/teachers/${teacherId}?page=${Math.max(1, page - 1)}&pageSize=${pageSize}`}
                >
                  ← Anterior
                </a>
                <span>Página {page} de {detail.pagination.totalPages}</span>
                <a
                  class={`px-3 py-2 rounded-lg border ${page < detail.pagination.totalPages ? "border-global-border hover:border-global-primary" : "border-transparent opacity-50 pointer-events-none"}`}
                  href={`/teachers/${teacherId}?page=${Math.min(detail.pagination.totalPages, page + 1)}&pageSize=${pageSize}`}
                >
                  Siguiente →
                </a>
              </div>
            )
          }
        </div>
      </section>
    </div>
  </main>
</Layout>

<div
  id="rating-modal"
  class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/60 backdrop-blur-sm"
>
  <div class="rating-modal relative w-full max-w-2xl rounded-3xl bg-global-card border border-global-border/50 p-6 shadow-2xl">
    <button
      type="button"
      id="close-rating-modal"
      class="absolute right-4 top-4 text-global-text-muted hover:text-global-primary"
      aria-label="Cerrar"
    >
      ✕
    </button>
    <h3 class="text-2xl font-semibold mb-4">Calificar a {detail.teacher.full_name}</h3>
    <TeacherRatingForm
      teacherId={detail.teacher.id}
      avg={detail.teacher.avg_overall}
      count={detail.teacher.rating_count}
      showSummary={false}
    />
  </div>
</div>

<style>
  /* Fuerza el formulario abierto dentro del modal y oculta el toggle interno */
  .rating-modal [data-toggle-form],
  .rating-modal .teacher-rating > div:first-child {
    display: none !important;
  }
  .rating-modal [data-rating-form] {
    display: block !important;
  }
  .rating-modal .teacher-rating {
    border: none;
    background: transparent;
    padding: 0;
  }
</style>

<script>
  const openBtn = document.getElementById('open-rating-modal');
  const modal = document.getElementById('rating-modal');
  const closeBtn = document.getElementById('close-rating-modal');

  const openModal = () => modal?.classList.remove('hidden');
  const closeModal = () => modal?.classList.add('hidden');

  openBtn?.addEventListener('click', openModal);
  closeBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });
</script>
