---
export const prerender = false;
import SiteHeader from "../../components/SiteHeader.astro";
import { supabaseAdmin } from "../../lib/supabase.server";

const sheetId = Number(Astro.params.id);
if (!sheetId) {
  return Astro.redirect("/cursos");
}

const supa = supabaseAdmin();
const { data: sheet, error } = await supa
  .from("sheets")
  .select(`
    id,
    exam_type,
    cycle,
    teacher_hint,
    exam_storage_path,
    solution_kind,
    solution_storage_path,
    solution_video_url,
    courses:course_id (code,name)
  `)
  .eq("id", sheetId)
  .single();

if (error || !sheet || !sheet.exam_storage_path) {
  return Astro.redirect("/cursos");
}

const courseRel = Array.isArray(sheet.courses) ? sheet.courses[0] : sheet.courses;
const courseCode = courseRel?.code ?? "Curso";
const courseName = courseRel?.name ?? "Curso";
const headerTitle = `${courseCode} - ${sheet.exam_type || "Plancha"} ${sheet.cycle || ""}`.trim();
const description =
  sheet.teacher_hint || `${sheet.exam_type || "Evaluacion"} - ${sheet.cycle || "Sin ciclo"}`.trim();

const iframeSrc = `/api/sheets/${sheet.id}/file?mode=stream`;

let solutionUrl: string | null = null;
if (sheet.solution_kind === "pdf" && sheet.solution_storage_path) {
  const { data } = await supa.storage
    .from("solutions")
    .createSignedUrl(sheet.solution_storage_path, 600);
  solutionUrl = data?.signedUrl ?? null;
} else if (sheet.solution_kind === "video" && sheet.solution_video_url) {
  solutionUrl = sheet.solution_video_url;
}

const downloadHref = `/api/sheets/${sheet.id}/file`;
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{headerTitle} | TrikaWeb</title>
  </head>

  <body class="min-h-screen bg-[#070809] text-white">
    <SiteHeader />

    <main class="mx-auto mb-10 w-[44.8%] max-w-[900px] px-0">
      <div
        id="header-container"
        class="sticky top-[60px] z-[1000] mb-0 flex items-center justify-between gap-3 rounded-t-xl rounded-b-none bg-[#171A1F] px-4 py-4"
      >
        <div>
          <p class="m-0 text-xs uppercase tracking-[0.2em] text-gray-400">{courseCode}</p>
          <h3 class="m-0 text-[22px] leading-none">{sheet.exam_type} - {sheet.cycle}</h3>
          <p class="m-0 text-sm text-gray-400">{courseName}</p>
        </div>
        <div class="flex items-center gap-2">
          <a
            id="download-btn"
            href={downloadHref}
            target="_blank"
            rel="noreferrer"
            class="rounded-lg bg-[#2A3240] px-4 py-2 hover:bg-[#1E2430]"
          >
            Descargar PDF
          </a>
          <a
            id="solution-btn"
            href={solutionUrl ?? "#"}
            class="rounded-lg bg-[#2A3240] px-4 py-2 inline-flex items-center justify-center hover:bg-[#1E2430]"
            aria-label="Ver solucionario"
            target="_blank"
            rel="noreferrer"
            class:list={!solutionUrl ? ["pointer-events-none", "opacity-40"] : []}
          >
            Solucionario
          </a>
          <button id="exit-btn" class="rounded-lg bg-[#2A3240] px-3 py-2 hover:bg-[#1E2430]">X</button>
        </div>
      </div>

      <div
        id="pdf-container"
        class="flex h-[1205px] w-full justify-center border-4 border-[#171A1F] p-5"
      >
        {iframeSrc ? (
          <iframe
            id="pdf-frame"
            src={`${iframeSrc}#toolbar=0&navpanes=0`}
            class="w-full h-full bg-[#0b0e13] rounded-lg border-0"
            loading="lazy"
            title="Visor de plancha"
            allowfullscreen
          ></iframe>
        ) : (
          <p class="text-sm text-gray-300 text-center">
            No pudimos cargar el PDF.
          </p>
        )}
      </div>

      <section
        id="difficulty-panel"
        class="mt-4 w-full rounded-xl bg-[#1E232B] px-5 py-5 text-white shadow-xl"
        aria-labelledby="difficulty-title"
      >
        <h4 id="difficulty-title" class="mb-3 text-center text-lg font-semibold">
          Que dificultad tiene?
        </h4>

        <div class="flex items-center justify-between gap-4">
          <span class="text-sm text-gray-300">Mas facil</span>

          <div class="flex items-center gap-5" role="radiogroup" aria-label="Dificultad">
            {Array.from({ length: 5 }).map((_, i) => (
              <button
                type="button"
                class="star btn-star"
                data-value={(i + 1).toString()}
                aria-label={`Dificultad ${i + 1} de 5`}
                aria-checked="false"
                role="radio"
              >
                <svg
                  class="h-8 w-8 transition-transform duration-150 hover:scale-110"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"
                  />
                </svg>
              </button>
            ))}
          </div>

          <span class="text-sm text-gray-300">Mas dificil</span>
        </div>
        <p class="mt-3 text-center text-xs text-gray-400">
          Usa el bloque de calificacion del curso para registrar tu voto real.
        </p>
      </section>

    </main>

    <footer class="mt-auto w-full bg-black py-2 text-center text-sm text-white">
      (c) 2024 TrikaWeb. Todos los derechos reservados.
    </footer>

    <script type="module">
      import { ensureDeviceId } from "/src/lib/client/device";
      const SHEET_ID = {sheetId};

      const registerView = (type = "view") => {
        const payload = JSON.stringify({ device_id: ensureDeviceId(), type });
        const url = `/api/sheets/${SHEET_ID}/view`;
        if (navigator.sendBeacon) {
          navigator.sendBeacon(url, new Blob([payload], { type: "application/json" }));
          return;
        }
        fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: payload,
          keepalive: true,
        }).catch(() => undefined);
      };

      const exitBtn = document.getElementById("exit-btn");
      exitBtn?.addEventListener("click", () => {
        window.history.length > 1 ? window.history.back() : (window.location.href = "/");
      });

      const downloadBtn = document.getElementById("download-btn");
      downloadBtn?.addEventListener("click", () => registerView("download"));

      registerView("view");
    </script>
  </body>
</html>
