---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import CardExam from "../../components/CardExam.astro";
import { getCourseByCode } from "../../lib/data";

const code = Astro.params.code ?? "";
const course = await getCourseByCode(code);
if (!course) {
  return Astro.redirect("/cursos");
}

// Group sheets by exam_type
const sheetsByType: Record<string, typeof course.sheets> = {};
course.sheets.forEach((sheet) => {
  const type = sheet.exam_type || "Otros";
  if (!sheetsByType[type]) {
    sheetsByType[type] = [];
  }
  sheetsByType[type].push(sheet);
});

// Define exam type order and labels
const examTypeConfig: Record<string, string> = {
  PC1: "Práctica Calificada 1",
  PC2: "Práctica Calificada 2",
  PC3: "Práctica Calificada 3",
  PC4: "Práctica Calificada 4",
  PC5: "Práctica Calificada 5",
  EP: "Examen Parcial",
  EF: "Examen Final",
  M1: "Monografía 1",
  M2: "Monografía 2",
  L: "Laboratorios",
  Otros: "Otros Exámenes",
};

// Sort types in logical order
const typeOrder = [
  "PC1",
  "PC2",
  "PC3",
  "PC4",
  "PC5",
  "EP",
  "EF",
  "M1",
  "M2",
  "L",
  "Otros",
];
const sortedTypes = Object.keys(sheetsByType).sort((a, b) => {
  const indexA = typeOrder.indexOf(a);
  const indexB = typeOrder.indexOf(b);
  if (indexA === -1 && indexB === -1) return a.localeCompare(b);
  if (indexA === -1) return 1;
  if (indexB === -1) return -1;
  return indexA - indexB;
});
---

<Layout title={`Curso ${course.code}`}>
  <main class="mx-auto max-w-[1200px] px-4 sm:px-6 lg:px-12 py-10">
    {
      /* 
    <div class="mb-6">
      <a
        href="/cursos"
        class="inline-flex items-center gap-2 text-sm text-global-text-muted hover:text-global-primary transition-colors"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M19 12H5"></path>
          <path d="M12 19l-7-7 7-7"></path>
        </svg>
        Volver a Cursos
      </a>
    </div>
    */
    }

    <header
      class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-10"
    >
      <div>
        <span
          class="inline-block text-sm font-bold tracking-[0.2em] text-global-primary mb-2"
        >
          {course.code}
        </span>
        <h1
          class="text-4xl md:text-5xl font-bold text-global-text tracking-tight"
        >
          {course.name}
        </h1>
      </div>

      <div class="flex flex-col items-end gap-4">
        <div
          class="inline-flex p-1 bg-global-surface rounded-lg border border-global-border"
        >
          <a
            href={`/curso/${course.code}`}
            class="p-1.5 rounded-md bg-global-primary text-black shadow-sm transition-all"
            aria-label="Planchas"
            title="Planchas"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>
          </a>
          <a
            href={`/curso/${course.code}/profesores`}
            class="p-1.5 rounded-md text-global-text-muted hover:text-global-text hover:bg-global-bg/50 transition-all"
            aria-label="Profesores"
            title="Profesores"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
              ></path>
            </svg>
          </a>
        </div>

        <div class="flex items-center gap-2 text-global-text-muted">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            ></path>
          </svg>
          <span class="text-base">
            {course.sheetCount} planchas
          </span>
        </div>
      </div>
    </header>

    {
      course.sheets.length === 0 ? (
        <p class="rounded-2xl border border-dashed border-global-border/60 bg-global-surface p-6 text-center text-global-text-muted">
          Aun no hay planchas para este curso.
        </p>
      ) : (
        <>
          {/* Sticky tabs navigation */}
          <nav
            id="exam-tabs"
            class="sticky top-16 z-40 bg-global-bg border-b border-global-border mb-8 -mx-4 sm:-mx-6 lg:-mx-12 px-4 sm:px-6 lg:px-12"
          >
            <div class="flex gap-2 overflow-x-auto scrollbar-hide py-3">
              {sortedTypes.map((type) => (
                <button
                  data-tab={type}
                  class="exam-tab whitespace-nowrap px-4 py-2 rounded-lg text-sm text-global-text font-medium transition-colors hover:bg-global-primary hover:text-black"
                >
                  {type}
                </button>
              ))}
            </div>
          </nav>

          {/* Sections for each exam type */}
          {sortedTypes.map((type, typeIndex) => {
            const sheets = sheetsByType[type];
            const sectionTitle = examTypeConfig[type] || type;

            return (
              <section
                id={`section-${type}`}
                class="mb-8 scroll-mt-32 bg-global-surface rounded-2xl p-6 sm:p-8"
                data-exam-type={type}
              >
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-2xl font-semibold text-global-text">
                    {sectionTitle}
                  </h2>
                  <select
                    class="sort-dropdown px-3 py-1.5 text-sm bg-global-card border border-global-border rounded-lg text-global-text-muted hover:border-global-primary transition-colors cursor-pointer"
                    data-section={type}
                  >
                    <option value="cycle-desc">Ordenar por ciclo ▼</option>
                    <option value="cycle-asc">Ordenar por ciclo ▲</option>
                  </select>
                </div>

                <div class="flex gap-4 items-center">
                  {/* Left arrow */}
                  <button
                    class={`carousel-prev hidden lg:flex items-center justify-center w-8 h-8 rounded-full bg-global-card/50 hover:bg-global-border transition-colors flex-shrink-0`}
                    data-carousel={type}
                    aria-label="Anterior"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="15 18 9 12 15 6" />
                    </svg>
                  </button>

                  {/* Cards carousel */}
                  <div class="flex-1 overflow-hidden">
                    <div
                      class={`carousel-container-${type} grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 transition-all duration-500`}
                    >
                      {sheets.map((sheet, index) => {
                        const courseCode = sheet.course_code ?? "N/A";
                        return (
                          <article
                            class={`carousel-item-${type} w-full relative`}
                            data-index={index}
                            data-cycle={sheet.cycle || ""}
                            style={index >= 3 ? "display: none;" : ""}
                          >
                            {courseCode !== "N/A" && (
                              <a
                                href={`/curso/${courseCode}`}
                                class="absolute top-2 left-2 z-10 inline-flex items-center rounded-full bg-global-primary px-2.5 py-0.5 text-xs font-semibold text-black hover:bg-global-primary-hover transition-colors"
                                onclick="event.stopPropagation();"
                              >
                                {courseCode}
                              </a>
                            )}
                            <CardExam sheet={sheet} />
                          </article>
                        );
                      })}
                    </div>
                  </div>

                  {/* Right arrow */}
                  <button
                    class={`carousel-next hidden lg:flex items-center justify-center w-8 h-8 rounded-full bg-global-card/50 hover:bg-global-border transition-colors flex-shrink-0`}
                    data-carousel={type}
                    aria-label="Siguiente"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="9 18 15 12 9 6" />
                    </svg>
                  </button>
                </div>
              </section>
            );
          })}
        </>
      )
    }
  </main>
</Layout>

<script define:vars={{ sortedTypes }}>
  // Tab navigation
  function setupTabs() {
    const tabs = document.querySelectorAll(".exam-tab");

    if (!tabs.length) return;

    // Set first tab as active initially
    tabs[0].classList.add("bg-global-primary", "text-black");

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        const type = tab.getAttribute("data-tab");

        // Remove active class from all tabs
        tabs.forEach((t) => {
          t.classList.remove("bg-global-primary", "text-black");
        });

        // Add active class to clicked tab
        tab.classList.add("bg-global-primary", "text-black");

        // Scroll to section
        const section = document.getElementById(`section-${type}`);
        if (section) {
          section.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    });
  }

  // Sorting functionality
  function setupSorting() {
    const dropdowns = document.querySelectorAll(".sort-dropdown");

    dropdowns.forEach((dropdown) => {
      dropdown.addEventListener("change", (e) => {
        const target = e.target;
        const section = target.getAttribute("data-section");
        const order = target.value;
        const container = document.querySelector(
          `.carousel-container-${section}`,
        );

        if (!container) return;

        const items = Array.from(container.children);

        items.sort((a, b) => {
          const cycleA = a.getAttribute("data-cycle") || "";
          const cycleB = b.getAttribute("data-cycle") || "";

          if (order === "cycle-asc") {
            return cycleA.localeCompare(cycleB);
          } else {
            return cycleB.localeCompare(cycleA);
          }
        });

        // Reorder DOM
        items.forEach((item) => container.appendChild(item));

        // Reset carousel view
        resetCarousel(section || "");
      });
    });
  }

  // Carousel functionality
  function setupCarousel(type, totalItems) {
    let currentIndex = 0;
    const itemsPerPage = 3;
    const maxIndex = Math.max(0, totalItems - itemsPerPage);

    const prevBtn = document.querySelector(
      `.carousel-prev[data-carousel="${type}"]`,
    );
    const nextBtn = document.querySelector(
      `.carousel-next[data-carousel="${type}"]`,
    );
    const items = document.querySelectorAll(`.carousel-item-${type}`);

    if (!prevBtn || !nextBtn || items.length === 0) return;

    function updateCarousel() {
      items.forEach((item, index) => {
        const htmlItem = item;
        if (index >= currentIndex && index < currentIndex + itemsPerPage) {
          htmlItem.style.display = "";
        } else {
          htmlItem.style.display = "none";
        }
      });

      // Disable buttons at boundaries
      prevBtn.classList.toggle("opacity-50", currentIndex === 0);
      prevBtn.classList.toggle("cursor-not-allowed", currentIndex === 0);
      nextBtn.classList.toggle("opacity-50", currentIndex >= maxIndex);
      nextBtn.classList.toggle("cursor-not-allowed", currentIndex >= maxIndex);
    }

    prevBtn.addEventListener("click", () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateCarousel();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentIndex < maxIndex) {
        currentIndex++;
        updateCarousel();
      }
    });

    updateCarousel();
  }

  function resetCarousel(type) {
    const items = document.querySelectorAll(`.carousel-item-${type}`);
    items.forEach((item, index) => {
      const htmlItem = item;
      if (index < 3) {
        htmlItem.style.display = "";
      } else {
        htmlItem.style.display = "none";
      }
    });
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", () => {
    setupTabs();
    setupSorting();

    // Setup carousel for each exam type
    sortedTypes.forEach((type) => {
      const items = document.querySelectorAll(`.carousel-item-${type}`);
      setupCarousel(type, items.length);
    });
  });
</script>

<style>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>
