---
export const prerender = false;
import "../styles/global.css";
import Layout from "../layouts/Layout.astro";
import SearchAutocomplete from "../components/SearchAutocomplete.astro";
import CardExam from "../components/CardExam.astro";
import TeacherCard from "../components/TeacherCard.astro";
import {
  getTopSheetsByDifficulty,
  getTopSheetsByViews,
  getTopTeachers,
} from "../lib/data";

const [planchasPopulares, planchasDificiles, topTeachers] = await Promise.all([
  getTopSheetsByViews(6),
  getTopSheetsByDifficulty(6),
  getTopTeachers(6, 1),
]);
---

<Layout title="TrikaWeb">
  <div
    class="flex min-h-screen w-full flex-col items-center gap-12 mt-12 sm:mt-16 px-4"
  >
    <!-- Header now comes from Layout via <SiteHeader /> -->

    <section
      id="hero"
      class="mx-[19px] md:mx-auto flex flex-col md:flex-row max-w-[1200px] w-full items-center justify-center gap-10 rounded-2xl md:rounded-[40px] border-2 border-global-border bg-global-surface px-8 py-12 md:gap-12 md:px-20 md:py-20"
    >
      <div class="flex flex-col items-center gap-6 md:items-start shrink-0">
        <h1
          class="max-w-[580px] text-3xl md:text-[48px] leading-[1.1] font-bold text-global-text text-center md:text-left tracking-tight"
        >
          ¿Planchas y reseñas? <span
            class="inline-block bg-linear-to-r from-[#22C55E] to-[#4ade80] bg-clip-text text-transparent pb-2"
            >Todo en un solo lugar.</span
          >
        </h1>
        <p
          class="max-w-[500px] text-base md:text-[17px] leading-relaxed text-global-text-muted text-center md:text-left font-medium"
        >
          La experiencia de generaciones, organizada <br
            class="hidden md:block"
          /> para que estudies mejor y evites la trika.
        </p>
        <div class="pt-2">
          <a
            href="#planchas"
            class="inline-flex items-center justify-center rounded-2xl bg-global-primary hover:bg-global-primary-hover px-8 py-4 text-base font-bold text-black transition-all hover:scale-105 focus:outline-none focus-visible:ring-2 focus-visible:ring-global-primary shadow-[0_0_20px_rgba(34,197,94,0.3)]"
          >
            Explorar planchas
          </a>
        </div>
      </div>

      <div class="flex items-center justify-center shrink-0">
        <img
          src="/img/mascota.png"
          alt="Mascota Trika"
          class="h-auto w-auto max-w-[257px] drop-shadow-2xl animate-float"
          loading="lazy"
          decoding="async"
        />
      </div>
    </section>

    <!--SECCION DE PLANCHAS -->

    <section
      id="planchas"
      class="mx-auto flex w-full max-w-[1200px] flex-col items-center gap-9 rounded-2xl bg-global-surface px-4 sm:px-10 py-16"
    >
      <div class="flex w-full flex-col md:flex-row items-center gap-8">
        <div class="w-full md:w-[118px] text-center md:text-left">
          <h2 class="text-[32px] leading-10 font-semibold">Planchas</h2>
        </div>

        <div class="flex w-full flex-1 justify-center md:justify-end">
          <SearchAutocomplete
            id="plancha"
            placeholder="Ingresa el curso, evaluacion o ciclo..."
            targetSelector=".plancha-card"
            fields="curso,evaluacion,ciclo"
            filter="curso,evaluacion,ciclo,solucion"
            class="max-w-[400px]"
          />
        </div>
      </div>

      <!-- Más visitadas section -->
      <div class="w-full mt-8">
        <div class="flex gap-4 items-center">
          <!-- Left arrow -->
          <button
            id="prev-popular"
            class="hidden lg:flex items-center justify-center w-8 h-8 rounded-full bg-global-card/50 hover:bg-global-border transition-colors flex-shrink-0"
            aria-label="Anterior"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>

          <!-- Cards grid -->
          <div class="flex-1">
            <!-- Mobile title (shown on small screens) -->
            <div class="lg:hidden text-center mb-6 w-full">
              <h3 class="text-[24px] leading-8 font-medium">Más visitadas</h3>
              <p class="text-sm text-global-text-muted mt-2">
                Se actualizan con descargas y vistas.
              </p>
            </div>

            <div
              id="carousel-popular"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 w-full transition-all duration-500"
            >
              {
                planchasPopulares.length === 0 ? (
                  <p class="col-span-full rounded-xl border border-dashed border-global-border bg-black/10 p-6 text-center text-global-text-muted">
                    Aun no hay planchas con vistas registradas.
                  </p>
                ) : (
                  planchasPopulares.map((sheet, index) => {
                    const courseCode = sheet.course_code ?? "N/A";
                    return (
                      <article
                        class="plancha-card carousel-item-popular w-full relative"
                        data-index={index}
                        data-curso={
                          sheet.course_name ?? sheet.course_code ?? "Curso"
                        }
                        data-evaluacion={sheet.exam_type}
                        data-ciclo={sheet.cycle}
                        data-solucion={sheet.solution_kind ? "si" : "no"}
                        style={index >= 3 ? "display: none;" : ""}
                      >
                        {courseCode !== "N/A" && (
                          <a
                            href={`/curso/${courseCode}`}
                            class="absolute top-2 left-2 z-10 inline-flex items-center rounded-full bg-global-primary px-2.5 py-0.5 text-xs font-semibold text-black hover:bg-global-primary-hover transition-colors"
                            onclick="event.stopPropagation();"
                          >
                            {courseCode}
                          </a>
                        )}
                        <CardExam sheet={sheet} />
                      </article>
                    );
                  })
                )
              }
            </div>
          </div>

          <!-- Right arrow -->
          <button
            id="next-popular"
            class="hidden lg:flex items-center justify-center w-8 h-8 rounded-full bg-global-card/50 hover:bg-global-border transition-colors flex-shrink-0"
            aria-label="Siguiente"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>

          <!-- Right title -->
          <div class="hidden lg:block min-w-[110px] flex-shrink-0">
            <h3 class="text-[20px] leading-6 font-medium">
              Planchas<br />Populares
            </h3>
            <p class="text-xs text-global-text-muted mt-2 leading-relaxed">
              Se actualizan<br />con vistas
            </p>
          </div>
        </div>
      </div>

      <!-- Más difíciles section -->
      <div class="w-full mt-8">
        <div class="flex gap-4 items-center">
          <!-- Left arrow -->
          <button
            id="prev-difficult"
            class="hidden lg:flex items-center justify-center w-8 h-8 rounded-full bg-global-card/50 hover:bg-global-border transition-colors flex-shrink-0"
            aria-label="Anterior"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>

          <!-- Cards grid -->
          <div class="flex-1">
            <!-- Mobile title (shown on small screens) -->
            <div class="lg:hidden text-center mb-6 w-full">
              <h3 class="text-[24px] leading-8 font-medium">Más difíciles</h3>
              <p class="text-sm text-global-text-muted mt-2">
                Basado en los votos de dificultad.
              </p>
            </div>

            <div
              id="carousel-difficult"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 transition-all duration-500"
            >
              {
                planchasDificiles.length === 0 ? (
                  <p class="col-span-full rounded-xl border border-dashed border-global-border bg-black/10 p-6 text-center text-global-text-muted">
                    Aun no hay votos de dificultad suficientes.
                  </p>
                ) : (
                  planchasDificiles.map((sheet, index) => {
                    const courseCode = sheet.course_code ?? "N/A";
                    return (
                      <article
                        class="plancha-card carousel-item-difficult w-full relative"
                        data-index={index}
                        data-curso={
                          sheet.course_name ?? sheet.course_code ?? "Curso"
                        }
                        data-evaluacion={sheet.exam_type}
                        data-ciclo={sheet.cycle}
                        data-solucion={sheet.solution_kind ? "si" : "no"}
                        style={index >= 3 ? "display: none;" : ""}
                      >
                        {courseCode !== "N/A" && (
                          <a
                            href={`/curso/${courseCode}`}
                            class="absolute top-2 left-2 z-10 inline-flex items-center rounded-full bg-global-primary px-2.5 py-0.5 text-xs font-semibold text-black hover:bg-global-primary-hover transition-colors"
                            onclick="event.stopPropagation();"
                          >
                            {courseCode}
                          </a>
                        )}
                        <CardExam sheet={sheet} />
                      </article>
                    );
                  })
                )
              }
            </div>
          </div>

          <!-- Right arrow -->
          <button
            id="next-difficult"
            class="hidden lg:flex items-center justify-center w-8 h-8 rounded-full bg-global-card/50 hover:bg-global-border transition-colors flex-shrink-0"
            aria-label="Siguiente"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>

          <!-- Right title -->
          <div class="hidden lg:block min-w-[110px] flex-shrink-0">
            <h3 class="text-[20px] leading-6 font-medium">
              Planchas<br />Difíciles
            </h3>
            <p class="text-xs text-global-text-muted mt-2 leading-relaxed">
              Basado en<br />votos
            </p>
          </div>
        </div>
      </div>
    </section>

    <!--Seccion de profesores -->

    <section
      id="profesores"
      class="mx-auto flex w-full max-w-[1200px] flex-col items-center gap-6 rounded-2xl bg-global-surface px-6 sm:px-12 md:px-16 py-16"
    >
      <div
        class="flex w-full items-start justify-between flex-wrap gap-4 px-2 sm:px-0"
      >
        <h2 class="text-[32px] leading-10 font-semibold">Profesores</h2>
        <a
          href="/teachers"
          class="inline-flex items-center justify-center rounded-full border border-global-border px-4 py-2 text-sm font-semibold text-global-text hover:border-global-primary"
        >
          Ver todos
        </a>
      </div>

      {
        topTeachers.length === 0 ? (
          <p class="rounded-xl border border-dashed border-global-border bg-black/10 p-6 text-center text-global-text-muted w-full">
            Aun no hay calificaciones de profesores.
          </p>
        ) : (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full mt-6">
            {topTeachers.map((teacher) => (
              <TeacherCard
                name={teacher.full_name}
                role={teacher.courses?.[0]?.code ?? "Profesor"}
                courses={teacher.courses?.map((c) => c.code) ?? []}
                rating={teacher.avg_overall ?? 0}
                avatarSrc={teacher.avatar_url ?? undefined}
                href={`/teachers/${teacher.id}`}
                buttonLabel="Calificar"
              />
            ))}
          </div>
        )
      }
    </section>
  </div>
</Layout>

<script>
  // Carousel functionality
  function setupCarousel(
    prevBtnId: string,
    nextBtnId: string,
    itemClass: string,
    totalItems: number,
  ) {
    let currentIndex = 0;
    const itemsPerPage = 3;
    const maxIndex = Math.max(0, totalItems - itemsPerPage);

    const prevBtn = document.getElementById(prevBtnId);
    const nextBtn = document.getElementById(nextBtnId);
    const items = document.querySelectorAll(`.${itemClass}`);

    if (!prevBtn || !nextBtn || items.length === 0) return;

    function updateCarousel() {
      items.forEach((item, index) => {
        const htmlItem = item as HTMLElement;
        if (index >= currentIndex && index < currentIndex + itemsPerPage) {
          htmlItem.style.display = "";
        } else {
          htmlItem.style.display = "none";
        }
      });

      // Disable buttons at boundaries
      if (prevBtn) {
        prevBtn.classList.toggle("opacity-50", currentIndex === 0);
        prevBtn.classList.toggle("cursor-not-allowed", currentIndex === 0);
      }
      if (nextBtn) {
        nextBtn.classList.toggle("opacity-50", currentIndex >= maxIndex);
        nextBtn.classList.toggle(
          "cursor-not-allowed",
          currentIndex >= maxIndex,
        );
      }
    }

    prevBtn.addEventListener("click", () => {
      if (currentIndex > 0) {
        currentIndex--;
        updateCarousel();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentIndex < maxIndex) {
        currentIndex++;
        updateCarousel();
      }
    });

    updateCarousel();
  }

  // Initialize carousels on page load
  document.addEventListener("DOMContentLoaded", () => {
    const popularItems = document.querySelectorAll(".carousel-item-popular");
    const difficultItems = document.querySelectorAll(
      ".carousel-item-difficult",
    );

    setupCarousel(
      "prev-popular",
      "next-popular",
      "carousel-item-popular",
      popularItems.length,
    );

    setupCarousel(
      "prev-difficult",
      "next-difficult",
      "carousel-item-difficult",
      difficultItems.length,
    );
  });
</script>
