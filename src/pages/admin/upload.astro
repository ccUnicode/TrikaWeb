---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Admin – Subir material | TrikaWeb">
  <div class="min-h-screen py-8">
    <div class="mx-auto w-full max-w-3xl px-4">
      <!-- Header Section -->
      <div class="mb-8 flex flex-row items-center justify-between gap-4">
        <div>
          <h1 class="text-2xl font-bold text-global-text">Panel de subida</h1>
          <p class="mt-1 text-sm text-global-text-muted">
            Sube PDFs de planchas y solucionarios
          </p>
        </div>
        <div class="flex flex-row gap-4">
          <a
            href="/admin/teachers"
            class="rounded-lg bg-global-card border border-global-border px-4 py-2 text-sm font-medium text-global-text transition hover:bg-global-border"
          >
            Profesores
          </a>
          <a
            href="/admin/ratings"
            class="rounded-lg bg-global-card border border-global-border px-4 py-2 text-sm font-medium text-global-text transition hover:bg-global-border"
          >
            Calificaciones
          </a>
          <a
            href="/admin/moderation"
            class="rounded-lg bg-global-card border border-global-border px-4 py-2 text-sm font-medium text-global-text transition hover:bg-global-border"
          >
            Moderar comentarios
          </a>
          <form action="/api/admin/logout" method="POST">
            <button
              type="submit"
              class="rounded-lg bg-red-600/20 border border-red-600/30 px-4 py-2 text-sm font-medium text-red-400 transition hover:bg-red-600/30 cursor-pointer"
            >
              Cerrar Sesión
            </button>
          </form>
        </div>
      </div>

      <!-- Upload Form Card -->
      <section
        class="rounded-2xl bg-global-surface border border-global-border p-6 mb-6"
      >
        <h2 class="text-lg font-semibold text-global-text mb-4">
          Subir archivo
        </h2>

        <form id="upload-form" class="space-y-4">
          <!-- Row 1: Course Code & Cycle -->
          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <label
                class="block text-sm font-medium text-global-text-muted mb-1.5"
                for="course-code"
              >
                Código de curso
              </label>
              <input
                id="course-code"
                name="course_code"
                type="text"
                required
                class="w-full rounded-xl border border-global-border bg-global-bg px-3 py-2.5 text-sm text-global-text outline-none focus:border-global-primary focus:ring-1 focus:ring-global-primary transition-colors"
                placeholder="Ej: BMA02"
              />
            </div>
            <div>
              <label
                class="block text-sm font-medium text-global-text-muted mb-1.5"
                for="cycle"
              >
                Ciclo
              </label>
              <input
                id="cycle"
                name="cycle"
                type="text"
                required
                class="w-full rounded-xl border border-global-border bg-global-bg px-3 py-2.5 text-sm text-global-text outline-none focus:border-global-primary focus:ring-1 focus:ring-global-primary transition-colors"
                placeholder="Ej: 2024-II"
              />
            </div>
          </div>

          <!-- Row 2: Exam Type & Teacher -->
          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <label
                class="block text-sm font-medium text-global-text-muted mb-1.5"
                for="exam-type"
              >
                Evaluación
              </label>
              <input
                id="exam-type"
                name="exam_type"
                type="text"
                required
                class="w-full rounded-xl border border-global-border bg-global-bg px-3 py-2.5 text-sm text-global-text outline-none focus:border-global-primary focus:ring-1 focus:ring-global-primary transition-colors"
                placeholder="Ej: PC1, Parcial, Final"
              />
            </div>
            <div>
              <label
                class="block text-sm font-medium text-global-text-muted mb-1.5"
                for="teacher-hint"
              >
                Docente <span class="text-global-text-muted">(opcional)</span>
              </label>
              <input
                id="teacher-hint"
                name="teacher_hint"
                type="text"
                class="w-full rounded-xl border border-global-border bg-global-bg px-3 py-2.5 text-sm text-global-text outline-none focus:border-global-primary focus:ring-1 focus:ring-global-primary transition-colors"
                placeholder="Prof. Arámbulo, etc."
              />
            </div>
          </div>

          <!-- Row 3: Resource Type & File -->
          <div class="grid gap-4 sm:grid-cols-2">
            <div>
              <label
                class="block text-sm font-medium text-global-text-muted mb-1.5"
                for="resource-kind"
              >
                Tipo de recurso
              </label>
              <select
                id="resource-kind"
                name="resource_kind"
                class="w-full rounded-xl border border-global-border bg-global-card px-3 py-2.5 text-sm text-global-text outline-none focus:border-global-primary focus:ring-1 focus:ring-global-primary transition-colors cursor-pointer"
              >
                <option value="PLANCHA">Plancha</option>
                <option value="SOLUCIONARIO">Solucionario</option>
              </select>
            </div>
            <div>
              <label
                class="block text-sm font-medium text-global-text-muted mb-1.5"
                for="file"
              >
                Archivo PDF
              </label>
              <label
                for="file"
                class="flex justify-between items-center gap-3 w-full rounded-xl border border-global-border bg-global-card px-3 py-2 cursor-pointer hover:border-global-primary transition-colors"
              >
                <span
                  class="inline-flex items-center rounded-lg bg-global-primary px-3 py-1 text-sm font-semibold text-black whitespace-nowrap"
                >
                  Seleccionar
                </span>
                <span
                  id="file-name"
                  class="text-sm text-global-text-muted truncate"
                >
                  Sin archivo
                </span>
              </label>
              <input
                id="file"
                name="file"
                type="file"
                accept="application/pdf"
                required
                class="hidden"
              />
            </div>
          </div>

          <p class="text-xs text-global-text-muted">
            Para solucionarios, usa los mismos campos de la plancha existente.
          </p>

          <!-- Upload Status -->
          <div id="upload-status" class="hidden">
            <div class="flex items-center gap-2 text-sm">
              <div
                id="upload-spinner"
                class="animate-spin h-4 w-4 border-2 border-global-primary border-t-transparent rounded-full"
              >
              </div>
              <span id="upload-message" class="text-global-text-muted"
                >Preparando subida...</span
              >
            </div>
            <div
              class="mt-2 w-full bg-global-border rounded-full h-1.5 overflow-hidden"
            >
              <div
                id="upload-progress"
                class="h-full bg-global-primary rounded-full transition-all duration-300"
                style="width: 0%"
              >
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <button
            id="upload-submit-btn"
            type="submit"
            class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-global-primary px-6 py-2.5 text-sm font-semibold text-black shadow-lg shadow-green-500/20 transition hover:bg-global-primary-hover cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"
              ></path>
            </svg>
            Subir archivo
          </button>
        </form>
      </section>

      <!-- Drive Sync Card -->
      <section
        class="rounded-2xl bg-global-surface border border-global-border p-6"
      >
        <div
          class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4"
        >
          <div>
            <h2 class="text-lg font-semibold text-global-text">
              Sincronización con Drive
            </h2>
            <p class="mt-0.5 text-sm text-global-text-muted">
              Importa automáticamente desde Google Drive
            </p>
          </div>
        </div>

        <div class="flex flex-wrap gap-4 justify-center">
          <button
            id="sync-exams-btn"
            type="button"
            class="inline-flex items-center gap-2 rounded-xl border border-global-border bg-global-card px-4 py-2.5 text-sm font-medium text-global-text transition hover:bg-global-border cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg
              class="w-4 h-4 text-global-primary"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>
            Sincronizar Exámenes
          </button>
          <button
            id="sync-solutions-btn"
            type="button"
            class="inline-flex items-center gap-2 rounded-xl border border-global-border bg-global-card px-4 py-2.5 text-sm font-medium text-global-text transition hover:bg-global-border cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg
              class="w-4 h-4 text-global-primary"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Sincronizar Solucionarios
          </button>
          <button
            id="sync-all-btn"
            type="button"
            class="inline-flex items-center gap-2 rounded-xl bg-global-primary px-4 py-2.5 text-sm font-semibold text-black transition hover:bg-global-primary-hover cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
            Sincronizar Todo
          </button>
        </div>

        <!-- Status Display -->
        <div id="sync-status" class="mt-4 hidden">
          <div class="flex items-center gap-2 text-sm">
            <div
              id="sync-spinner"
              class="animate-spin h-4 w-4 border-2 border-global-primary border-t-transparent rounded-full"
            >
            </div>
            <span id="sync-message" class="text-global-text-muted"
              >Iniciando sincronización...</span
            >
          </div>
        </div>

        <!-- Results Display -->
        <div id="sync-results" class="mt-4 hidden">
          <pre
            class="text-xs text-global-text-muted bg-global-bg p-3 rounded-lg overflow-x-auto max-h-48 overflow-y-auto border border-global-border">
          </pre>
        </div>

        <div
          class="mt-4 rounded-lg bg-global-bg/50 border border-global-border p-3"
        >
          <p class="text-xs text-global-text-muted">
            <strong class="text-global-text">Nota:</strong> La sincronización se ejecuta
            localmente en tu computadora. Usa el comando: <code
              class="bg-global-card px-1.5 py-0.5 rounded border border-global-border"
              >npm run drive:sync-solutions</code
            >
          </p>
        </div>
      </section>
    </div>
  </div>

  <script>
    const syncExamsBtn = document.getElementById("sync-exams-btn");
    const syncSolutionsBtn = document.getElementById("sync-solutions-btn");
    const syncAllBtn = document.getElementById("sync-all-btn");
    const syncStatus = document.getElementById("sync-status");
    const syncMessage = document.getElementById("sync-message");
    const syncResults = document.getElementById("sync-results");
    const syncResultsPre = syncResults?.querySelector("pre");

    async function runSync(type: string) {
      // Disable all buttons
      [syncExamsBtn, syncSolutionsBtn, syncAllBtn].forEach((btn) => {
        btn?.setAttribute("disabled", "true");
      });

      // Show status
      syncStatus?.classList.remove("hidden");
      syncResults?.classList.add("hidden");
      document.getElementById("sync-spinner")?.classList.remove("hidden");
      if (syncMessage) syncMessage.textContent = `Sincronizando ${type}...`;

      try {
        const res = await fetch("/api/admin/drive-sync", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type }),
        });

        const data = await res.json();

        if (syncResultsPre) {
          syncResultsPre.textContent = JSON.stringify(data, null, 2);
        }
        syncResults?.classList.remove("hidden");

        if (data.ok) {
          if (syncMessage)
            syncMessage.textContent = "✅ Sincronización completada";
        } else {
          if (syncMessage)
            syncMessage.textContent = `⚠️ ${data.error || "Error desconocido"}`;
        }
      } catch (err) {
        if (syncMessage) syncMessage.textContent = `❌ Error de red: ${err}`;
      } finally {
        // Re-enable buttons
        [syncExamsBtn, syncSolutionsBtn, syncAllBtn].forEach((btn) => {
          btn?.removeAttribute("disabled");
        });
        // Hide spinner
        setTimeout(() => {
          document.getElementById("sync-spinner")?.classList.add("hidden");
        }, 500);
      }
    }

    syncExamsBtn?.addEventListener("click", () => runSync("exams"));
    syncSolutionsBtn?.addEventListener("click", () => runSync("solutions"));
    syncAllBtn?.addEventListener("click", () => runSync("all"));

    // Update file name display when file is selected
    const fileInput = document.getElementById("file") as HTMLInputElement;
    const fileNameEl = document.getElementById("file-name");
    fileInput?.addEventListener("change", () => {
      if (fileInput.files && fileInput.files.length > 0) {
        if (fileNameEl) fileNameEl.textContent = fileInput.files[0].name;
      } else {
        if (fileNameEl) fileNameEl.textContent = "Sin archivos seleccionados";
      }
    });

    // ── Two-Step Upload (bypasses Vercel 4.5MB limit) ──────────────
    const uploadForm = document.getElementById(
      "upload-form",
    ) as HTMLFormElement;
    const uploadStatus = document.getElementById("upload-status");
    const uploadSpinner = document.getElementById("upload-spinner");
    const uploadMessage = document.getElementById("upload-message");
    const uploadProgress = document.getElementById(
      "upload-progress",
    ) as HTMLDivElement;
    const submitBtn = document.getElementById(
      "upload-submit-btn",
    ) as HTMLButtonElement;

    function setUploadUI(msg: string, pct: number, showSpinner = true) {
      uploadStatus?.classList.remove("hidden");
      if (uploadMessage) uploadMessage.textContent = msg;
      if (uploadProgress) uploadProgress.style.width = `${pct}%`;
      if (showSpinner) {
        uploadSpinner?.classList.remove("hidden");
      } else {
        uploadSpinner?.classList.add("hidden");
      }
    }

    function resetUploadUI() {
      uploadStatus?.classList.add("hidden");
      if (uploadProgress) uploadProgress.style.width = "0%";
      submitBtn?.removeAttribute("disabled");
    }

    uploadForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(uploadForm);
      const courseCode = String(formData.get("course_code") ?? "").trim();
      const cycle = String(formData.get("cycle") ?? "").trim();
      const examType = String(formData.get("exam_type") ?? "").trim();
      const teacherHint = String(formData.get("teacher_hint") ?? "").trim();
      const resourceKind = String(formData.get("resource_kind") ?? "").trim();
      const file = (formData.get("file") as File) || null;

      if (
        !courseCode ||
        !cycle ||
        !examType ||
        !resourceKind ||
        !file ||
        file.size === 0
      ) {
        alert("Por favor completa todos los campos y selecciona un archivo.");
        return;
      }

      submitBtn?.setAttribute("disabled", "true");

      try {
        // Step 1: Get signed upload URL
        setUploadUI("Obteniendo URL de subida...", 10);

        const urlRes = await fetch("/api/admin/upload-url", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            course_code: courseCode,
            cycle,
            exam_type: examType,
            resource_kind: resourceKind,
          }),
        });

        const urlData = await urlRes.json();
        if (!urlData.ok) {
          setUploadUI(`❌ ${urlData.error}`, 0, false);
          submitBtn?.removeAttribute("disabled");
          return;
        }

        // Step 2: Upload PDF directly to Supabase Storage
        setUploadUI("Subiendo archivo a Storage...", 40);

        const uploadRes = await fetch(urlData.signedUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/pdf" },
          body: file,
        });

        if (!uploadRes.ok) {
          const errText = await uploadRes.text();
          console.error("Storage upload failed:", errText);
          setUploadUI("❌ Error al subir el archivo a Storage", 40, false);
          submitBtn?.removeAttribute("disabled");
          return;
        }

        // Step 3: Register metadata in DB
        setUploadUI("Registrando en la base de datos...", 80);

        const regRes = await fetch("/api/admin/upload", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            course_id: urlData.courseId,
            cycle,
            exam_type: examType,
            resource_kind: resourceKind,
            storage_path: urlData.path,
            teacher_hint: teacherHint,
          }),
        });

        const regData = await regRes.json();

        if (!regData.ok) {
          setUploadUI(`⚠️ Archivo subido, pero: ${regData.error}`, 80, false);
          submitBtn?.removeAttribute("disabled");
          return;
        }

        // Success!
        setUploadUI(`✅ ${regData.message}`, 100, false);
        uploadForm.reset();
        if (fileNameEl) fileNameEl.textContent = "Sin archivo";

        // Auto-hide success message after 4 seconds
        setTimeout(() => resetUploadUI(), 4000);
      } catch (err) {
        console.error("Upload error:", err);
        setUploadUI(`❌ Error de red: ${err}`, 0, false);
        submitBtn?.removeAttribute("disabled");
      }
    });
  </script>
</Layout>
