---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Gestionar Calificaciones | TrikaWeb Admin">
    <div class="min-h-screen py-8">
        <div class="mx-auto w-full max-w-4xl px-4">
            <!-- Header Section -->
            <div class="mb-8 flex flex-row items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-global-text">
                        Gestionar Calificaciones
                    </h1>
                    <p class="mt-1 text-sm text-global-text-muted">
                        Elimina calificaciones y comentarios de profesores
                    </p>
                </div>
                <div class="flex gap-2">
                    <a
                        href="/admin/teachers"
                        class="rounded-lg bg-global-card border border-global-border px-4 py-2 text-sm font-medium text-global-text transition hover:bg-global-border"
                    >
                        Profesores
                    </a>
                    <a
                        href="/admin/moderation"
                        class="rounded-lg bg-global-card border border-global-border px-4 py-2 text-sm font-medium text-global-text transition hover:bg-global-border"
                    >
                        ← Moderación
                    </a>
                    <a
                        href="/admin/upload"
                        class="rounded-lg bg-global-card border border-global-border px-4 py-2 text-sm font-medium text-global-text transition hover:bg-global-border"
                    >
                        Panel de subida
                    </a>
                    <form action="/api/admin/logout" method="POST">
                        <button
                            type="submit"
                            class="rounded-lg bg-red-600/20 border border-red-600/30 px-4 py-2 text-sm font-medium text-red-400 transition hover:bg-red-600/30 cursor-pointer"
                        >
                            Cerrar Sesión
                        </button>
                    </form>
                </div>
            </div>

            <!-- Ratings Section -->
            <section id="ratings-section" class="space-y-4">
                <!-- Search Bar -->
                <div class="flex gap-3">
                    <div class="relative flex-1">
                        <svg
                            class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-global-text-muted"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                            ></path>
                        </svg>
                        <input
                            id="search-input"
                            type="text"
                            placeholder="Buscar por profesor o comentario..."
                            class="w-full rounded-xl border border-global-border bg-global-bg pl-10 pr-4 py-2.5 text-sm text-global-text outline-none focus:border-global-primary focus:ring-1 focus:ring-global-primary transition-colors"
                        />
                    </div>
                    <button
                        id="search-btn"
                        type="button"
                        class="rounded-xl bg-global-primary px-4 py-2.5 text-sm font-semibold text-black transition hover:bg-global-primary-hover cursor-pointer"
                    >
                        Buscar
                    </button>
                    <button
                        id="clear-search-btn"
                        type="button"
                        class="hidden rounded-xl border border-global-border bg-global-card px-4 py-2.5 text-sm font-medium text-global-text transition hover:bg-global-border cursor-pointer"
                    >
                        Limpiar
                    </button>
                </div>

                <!-- Stats & Controls -->
                <div class="flex items-center justify-between flex-wrap gap-3">
                    <p class="text-sm text-global-text-muted">
                        <span
                            id="total-count"
                            class="font-semibold text-global-text">0</span
                        > calificaciones visibles
                    </p>
                    <div class="flex gap-2">
                        <button
                            id="refresh-btn"
                            type="button"
                            class="inline-flex items-center gap-2 rounded-lg border border-global-border bg-global-card px-3 py-1.5 text-sm text-global-text transition hover:bg-global-border cursor-pointer"
                        >
                            <svg
                                class="w-4 h-4"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
                                ></path>
                            </svg>
                            Actualizar
                        </button>
                    </div>
                </div>

                <!-- Ratings List -->
                <div id="ratings-list" class="space-y-4">
                    <!-- Ratings will be inserted here -->
                </div>

                <!-- Pagination -->
                <div
                    id="pagination"
                    class="hidden flex items-center justify-center gap-4 py-4"
                >
                    <button
                        id="prev-btn"
                        type="button"
                        class="rounded-lg border border-global-border bg-global-card px-4 py-2 text-sm text-global-text transition hover:bg-global-border disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                    >
                        ← Anterior
                    </button>
                    <span id="page-info" class="text-sm text-global-text-muted"
                        >Página 1 de 1</span
                    >
                    <button
                        id="next-btn"
                        type="button"
                        class="rounded-lg border border-global-border bg-global-card px-4 py-2 text-sm text-global-text transition hover:bg-global-border disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                    >
                        Siguiente →
                    </button>
                </div>

                <!-- Empty State -->
                <div
                    id="empty-state"
                    class="hidden rounded-2xl bg-global-surface border border-global-border p-8 text-center"
                >
                    <svg
                        class="mx-auto w-12 h-12 text-global-text-muted mb-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="1.5"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                    </svg>
                    <p class="text-global-text font-medium">
                        No hay calificaciones
                    </p>
                    <p class="text-sm text-global-text-muted mt-1">
                        No se encontraron calificaciones visibles
                    </p>
                </div>

                <!-- Loading State -->
                <div
                    id="loading-state"
                    class="rounded-2xl bg-global-surface border border-global-border p-8 text-center"
                >
                    <div
                        class="animate-spin h-8 w-8 border-2 border-global-primary border-t-transparent rounded-full mx-auto mb-3"
                    >
                    </div>
                    <p class="text-sm text-global-text-muted">
                        Cargando calificaciones...
                    </p>
                </div>
            </section>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentSearch = "";
        const pageSize = 15;

        const ratingsSection = document.getElementById("ratings-section");
        const ratingsList = document.getElementById("ratings-list");
        const emptyState = document.getElementById("empty-state");
        const loadingState = document.getElementById("loading-state");
        const totalCount = document.getElementById("total-count");
        const refreshBtn = document.getElementById("refresh-btn");
        const pagination = document.getElementById("pagination");
        const prevBtn = document.getElementById(
            "prev-btn",
        ) as HTMLButtonElement;
        const nextBtn = document.getElementById(
            "next-btn",
        ) as HTMLButtonElement;
        const pageInfo = document.getElementById("page-info");
        const searchInput = document.getElementById(
            "search-input",
        ) as HTMLInputElement;
        const searchBtn = document.getElementById("search-btn");
        const clearSearchBtn = document.getElementById("clear-search-btn");

        interface Rating {
            id: number;
            overall: number;
            difficulty: number;
            didactic: number;
            resources: number;
            responsability: number;
            grading: number;
            comment: string | null;
            created_at: string;
            teacher_id: number;
            teachers: {
                id: number;
                full_name: string;
            } | null;
        }

        async function loadRatings(page: number = 1, search: string = "") {
            currentPage = page;
            currentSearch = search;
            loadingState?.classList.remove("hidden");
            emptyState?.classList.add("hidden");
            pagination?.classList.add("hidden");
            if (ratingsList) ratingsList.innerHTML = "";

            // Show/hide clear button
            if (search) {
                clearSearchBtn?.classList.remove("hidden");
            } else {
                clearSearchBtn?.classList.add("hidden");
            }

            try {
                const res = await fetch("/api/admin/all-ratings", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({
                        page,
                        pageSize,
                        search,
                    }),
                });

                const data = await res.json();

                if (!data.ok) {
                    throw new Error(data.error || "Error desconocido");
                }

                const ratings: Rating[] = data.ratings ?? [];
                const paginationData = data.pagination;

                if (totalCount)
                    totalCount.textContent = String(paginationData.total);

                if (ratings.length === 0) {
                    emptyState?.classList.remove("hidden");
                } else {
                    renderRatings(ratings);

                    // Update pagination
                    if (paginationData.totalPages > 1) {
                        pagination?.classList.remove("hidden");
                        if (pageInfo) {
                            pageInfo.textContent = `Página ${paginationData.page} de ${paginationData.totalPages}`;
                        }
                        if (prevBtn) {
                            prevBtn.disabled = paginationData.page <= 1;
                        }
                        if (nextBtn) {
                            nextBtn.disabled =
                                paginationData.page >=
                                paginationData.totalPages;
                        }
                    }
                }
            } catch (err: any) {
                console.error("Error loading ratings:", err);
                if (ratingsList) {
                    ratingsList.innerHTML = `<div class="text-center text-red-400 p-4">${err.message}</div>`;
                }
            } finally {
                loadingState?.classList.add("hidden");
            }
        }

        function renderRatings(ratings: Rating[]) {
            if (!ratingsList) return;

            ratingsList.innerHTML = ratings
                .map((r) => {
                    const teacherName =
                        r.teachers?.full_name ?? "Profesor desconocido";
                    const date = new Date(r.created_at).toLocaleDateString(
                        "es-PE",
                        {
                            day: "numeric",
                            month: "short",
                            year: "numeric",
                            hour: "2-digit",
                            minute: "2-digit",
                        },
                    );
                    const overallStars =
                        "★".repeat(Math.round(r.overall)) +
                        "☆".repeat(5 - Math.round(r.overall));

                    // Check if rating is new (less than 24 hours old)
                    const createdDate = new Date(r.created_at);
                    const now = new Date();
                    const hoursDiff =
                        (now.getTime() - createdDate.getTime()) /
                        (1000 * 60 * 60);
                    const isNew = hoursDiff < 24;
                    const newBadge = isNew
                        ? '<span class="ml-2 px-2 py-0.5 text-[10px] font-bold uppercase bg-green-500/20 text-green-400 rounded-full border border-green-500/30">Nuevo</span>'
                        : "";

                    return `
          <div class="rounded-2xl bg-global-surface border border-global-border p-5 ${isNew ? "ring-1 ring-green-500/30" : ""}" data-rating-id="${r.id}">
            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-3">
              <div>
                <div class="flex items-center">
                  <a href="/profesores/${r.teacher_id}" target="_blank" class="font-semibold text-global-text hover:text-global-primary transition">
                    ${escapeHtml(teacherName)}
                  </a>
                  ${newBadge}
                </div>
                <p class="text-xs text-global-text-muted mt-0.5">${date}</p>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-yellow-400 text-sm">${overallStars}</span>
                <span class="text-xs text-global-text-muted">(${r.overall.toFixed(1)}/5)</span>
              </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-5 gap-2 text-xs text-center mb-3">
              <div class="bg-global-bg rounded-lg p-2">
                <p class="text-global-text-muted">Dificultad</p>
                <p class="font-semibold text-global-text">${r.difficulty}</p>
              </div>
              <div class="bg-global-bg rounded-lg p-2">
                <p class="text-global-text-muted">Didáctica</p>
                <p class="font-semibold text-global-text">${r.didactic}</p>
              </div>
              <div class="bg-global-bg rounded-lg p-2">
                <p class="text-global-text-muted">Recursos</p>
                <p class="font-semibold text-global-text">${r.resources}</p>
              </div>
              <div class="bg-global-bg rounded-lg p-2">
                <p class="text-global-text-muted">Resp.</p>
                <p class="font-semibold text-global-text">${r.responsability}</p>
              </div>
              <div class="bg-global-bg rounded-lg p-2">
                <p class="text-global-text-muted">Calif.</p>
                <p class="font-semibold text-global-text">${r.grading}</p>
              </div>
            </div>
            
            ${
                r.comment
                    ? `
            <p class="text-sm text-global-text bg-global-bg rounded-lg p-3 border border-global-border mb-4">
              ${escapeHtml(r.comment)}
            </p>
            `
                    : '<p class="text-sm text-global-text-muted italic mb-4">Sin comentario</p>'
            }
            
            <div class="flex gap-2 justify-end">
              <button
                type="button"
                onclick="deleteRating(${r.id})"
                class="inline-flex items-center gap-1.5 rounded-lg bg-red-600/20 border border-red-600/30 px-4 py-2 text-sm font-medium text-red-400 transition hover:bg-red-600/30 cursor-pointer"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Eliminar
              </button>
            </div>
          </div>
        `;
                })
                .join("");
        }

        function escapeHtml(text: string): string {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }

        (window as any).deleteRating = async function (id: number) {
            if (
                !confirm(
                    "¿Estás seguro de que quieres ELIMINAR esta calificación permanentemente? Esta acción no se puede deshacer.",
                )
            )
                return;

            const card = document.querySelector(`[data-rating-id="${id}"]`);
            if (card) card.classList.add("opacity-50", "pointer-events-none");

            try {
                const res = await fetch("/api/admin/delete-rating", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({
                        rating_id: id,
                    }),
                });

                const data = await res.json();

                if (data.ok) {
                    card?.remove();
                    updateCount(-1);
                } else {
                    alert("Error: " + (data.error ?? "No se pudo eliminar"));
                    if (card)
                        card.classList.remove(
                            "opacity-50",
                            "pointer-events-none",
                        );
                }
            } catch {
                alert("Error de red");
                if (card)
                    card.classList.remove("opacity-50", "pointer-events-none");
            }
        };

        function updateCount(delta: number) {
            if (!totalCount) return;
            const current = parseInt(totalCount.textContent ?? "0", 10);
            const newCount = Math.max(0, current + delta);
            totalCount.textContent = String(newCount);

            if (newCount === 0) {
                emptyState?.classList.remove("hidden");
                pagination?.classList.add("hidden");
            }
        }

        refreshBtn?.addEventListener("click", () =>
            loadRatings(currentPage, currentSearch),
        );
        prevBtn?.addEventListener("click", () =>
            loadRatings(currentPage - 1, currentSearch),
        );
        nextBtn?.addEventListener("click", () =>
            loadRatings(currentPage + 1, currentSearch),
        );

        // Search functionality
        const doSearch = () => {
            const query = searchInput?.value?.trim() || "";
            loadRatings(1, query);
        };

        searchBtn?.addEventListener("click", doSearch);
        searchInput?.addEventListener("keypress", (e) => {
            if (e.key === "Enter") doSearch();
        });
        clearSearchBtn?.addEventListener("click", () => {
            if (searchInput) searchInput.value = "";
            loadRatings(1, "");
        });

        // Load ratings on page load
        loadRatings(1);
    </script>
</Layout>
