---
export const prerender = false;
import Layout from "../../layouts/Layout.astro";
import { supabaseClient } from "../../lib/supabase.client";
import SheetRating from "../../components/SheetRating.astro";

const { id } = Astro.params;
const sheetId = Number(id);

if (!sheetId) {
    return Astro.redirect("/cursos");
}

const { data: sheet } = await supabaseClient
    .from("sheets")
    .select(
        `
    id,
    exam_type,
    cycle,
    teacher_hint,
    avg_difficulty,
    rating_count,
    view_count,
    solution_kind,
    courses (code, name)
  `,
    )
    .eq("id", sheetId)
    .single();

if (!sheet) {
    return Astro.redirect("/cursos");
}

// Extraer el c√≥digo del curso de forma segura
const courseCode =
    sheet.courses &&
    typeof sheet.courses === "object" &&
    "code" in sheet.courses
        ? sheet.courses.code
        : "Sin curso";

const courseName =
    sheet.courses &&
    typeof sheet.courses === "object" &&
    "name" in sheet.courses
        ? sheet.courses.name
        : "";
---

<Layout title={`${sheet.exam_type} - ${sheet.cycle} | TrikaWeb`}>
    <main class="mx-auto max-w-4xl px-4 py-10">
        <div
            class="bg-global-surface rounded-xl p-8 border border-global-border/30"
        >
            <a
                href={`/curso/${courseCode}`}
                class="text-global-primary hover:underline mb-4 inline-block text-sm"
            >
                &larr; Volver al curso
            </a>

            <h1 class="text-3xl font-bold text-global-text mb-2">
                {courseCode} - {sheet.exam_type}
            </h1>
            <h2 class="text-xl text-global-text-muted mb-6">{courseName}</h2>

            <div
                class="grid grid-cols-2 gap-6 mb-8 text-global-text p-4 bg-global-bg/50 rounded-lg"
            >
                <div>
                    <strong
                        class="text-global-text-muted block text-xs uppercase tracking-wider"
                        >Ciclo</strong
                    >
                    <span class="text-lg">{sheet.cycle}</span>
                </div>
                <div>
                    <strong
                        class="text-global-text-muted block text-xs uppercase tracking-wider"
                        >Profesor</strong
                    >
                    <span class="text-lg"
                        >{sheet.teacher_hint || "No especificado"}</span
                    >
                </div>
                <div>
                    <strong
                        class="text-global-text-muted block text-xs uppercase tracking-wider"
                        >Vistas</strong
                    >
                    <span class="text-lg">{sheet.view_count ?? 0}</span>
                </div>
                <div>
                    <strong
                        class="text-global-text-muted block text-xs uppercase tracking-wider"
                        >Calificaciones</strong
                    >
                    <span class="text-lg">{sheet.rating_count ?? 0}</span>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-lg font-semibold text-global-text mb-3">
                    Dificultad
                </h3>
                <SheetRating
                    sheetId={sheet.id}
                    avg={sheet.avg_difficulty}
                    count={sheet.rating_count}
                />
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
                <button
                    id="view-btn"
                    data-sheet-id={sheet.id}
                    class="flex-1 bg-global-primary hover:bg-global-primary-hover text-black font-semibold py-3 rounded-lg transition text-center"
                >
                    Ver examen
                </button>

                {
                    sheet.solution_kind && (
                        <button
                            id="solution-btn"
                            data-sheet-id={sheet.id}
                            class="flex-1 bg-global-surface border border-global-border hover:border-global-primary text-global-text font-semibold py-3 rounded-lg transition text-center"
                        >
                            Ver solucionario
                        </button>
                    )
                }
            </div>
        </div>
    </main>

    <script>
        import { ensureDeviceId } from "../../lib/client/device";

        const viewBtn = document.getElementById("view-btn");
        const solutionBtn = document.getElementById("solution-btn");

        viewBtn?.addEventListener("click", async () => {
            const sheetId = viewBtn.dataset.sheetId;
            const deviceId = ensureDeviceId();

            // Registrar vista (fire and forget via beacon if possible, or fetch)
            const url = `/api/sheets/${sheetId}/view`;
            const data = JSON.stringify({ device_id: deviceId, type: "view" });

            if (navigator.sendBeacon) {
                const blob = new Blob([data], { type: "application/json" });
                navigator.sendBeacon(url, blob);
            } else {
                fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: data,
                    keepalive: true,
                }).catch(() => undefined);
            }

            // Abrir examen
            window.open(`/api/sheets/${sheetId}/file`, "_blank");
        });

        solutionBtn?.addEventListener("click", () => {
            const sheetId = solutionBtn.dataset.sheetId;
            window.open(`/api/sheets/${sheetId}/solution`, "_blank");
        });
    </script>
</Layout>
