---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
---

<Layout
  title="Planchas Guardadas - TrikaWeb"
  description="Accede rápidamente a tus planchas y exámenes guardados de la UNI."
>
  <main class="mx-auto max-w-[1200px] px-4 py-10 min-h-screen">
    <header class="mb-8 flex items-center justify-between">
      <h1 class="text-3xl font-bold text-global-text">Mis Guardados</h1>
    </header>

    <div id="loading" class="py-12 text-center text-global-text-muted">
      Cargando tus planchas guardadas...
    </div>

    <div id="empty-state" class="hidden py-12 text-center">
      <p class="text-xl text-global-text-muted mb-4">
        Todavía no has guardado ninguna plancha.
      </p>
      <p class="text-sm text-global-text-muted">
        Usa el icono de corazón en las cards para guardarlas aquí.
      </p>
      <a
        href="/"
        class="mt-6 inline-block rounded-full bg-global-primary px-6 py-2 text-black font-semibold hover:bg-global-primary-hover"
      >
        Explorar planchas
      </a>
    </div>

    <div
      id="grid"
      class="hidden grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
    >
      <!-- Cards injected via JS -->
    </div>
  </main>
</Layout>

<script
  define:vars={{ PUBLIC_SUPABASE_URL: import.meta.env.PUBLIC_SUPABASE_URL }}
>
  // Inline logic to avoid module import issues
  function getFavorites() {
    try {
      const stored = localStorage.getItem("trikaweb:favorites");
      return stored ? JSON.parse(stored) : [];
    } catch {
      return [];
    }
  }

  function toggleFavorite(id) {
    const favs = getFavorites();
    const index = favs.indexOf(id);
    if (index >= 0) {
      favs.splice(index, 1);
    } else {
      favs.push(id);
    }
    localStorage.setItem("trikaweb:favorites", JSON.stringify(favs));
    window.dispatchEvent(
      new CustomEvent("favorites:updated", {
        detail: { id, active: index === -1 },
      }),
    );
  }

  const loading = document.getElementById("loading");
  const emptyState = document.getElementById("empty-state");
  const grid = document.getElementById("grid");

  async function loadSaved() {
    try {
      if (loading) loading.textContent = "Leyendo favoritos...";
      const ids = getFavorites();

      if (!ids.length) {
        loading?.classList.add("hidden");
        emptyState?.classList.remove("hidden");
        grid?.classList.add("hidden");
        return;
      }

      if (loading) loading.textContent = `Cargando ${ids.length} planchas...`;

      const res = await fetch("/api/sheets/batch", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids }),
      });

      if (!res.ok) {
        throw new Error(`Error del servidor: ${res.status}`);
      }

      const sheets = await res.json();

      if (!sheets.length) {
        loading?.classList.add("hidden");
        emptyState?.classList.remove("hidden");
        return;
      }

      renderGrid(sheets);
      loading?.classList.add("hidden");
      emptyState?.classList.add("hidden");
      grid?.classList.remove("hidden");
    } catch (e) {
      if (loading) {
        loading.innerHTML = `
          <p class="text-red-500 mb-2">Ocurrió un error al cargar.</p>
          <p class="text-xs text-gray-500 font-mono">${e instanceof Error ? e.message : String(e)}</p>
          <button onclick="location.reload()" class="mt-4 underline text-sm">Reintentar</button>
        `;
      }
    }
  }

  function getThumbUrl(path) {
    if (!path) return null;
    if (!PUBLIC_SUPABASE_URL) return null; // Safety check

    // Remove "thumbnails/" prefix if present
    const cleanPath = path.startsWith("thumbnails/")
      ? path.replace("thumbnails/", "")
      : path;

    // Construct public URL manually to avoid dependency
    return `${PUBLIC_SUPABASE_URL}/storage/v1/object/public/thumbnails/${cleanPath}`;
  }

  function renderGrid(sheets) {
    if (!grid) return;
    grid.innerHTML = "";

    sheets.forEach((sheet) => {
      const thumbUrl = getThumbUrl(sheet.thumb_storage_path);

      const card = document.createElement("article");
      card.className = "w-full";
      card.innerHTML = `
        <a href="/exams/${sheet.id}" class="flex w-full h-auto flex-col gap-2 rounded-lg bg-global-card p-4 shadow-lg transition-transform hover:scale-105 relative group">
          <button class="absolute top-2 right-2 z-10 p-2 text-red-500 hover:scale-110 transition bg-white/10 rounded-full backdrop-blur-sm" data-remove-id="${sheet.id}" title="Quitar de guardados">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
          </button>
          
          ${
            thumbUrl
              ? `<img src="${thumbUrl}" alt="Miniatura de ${sheet.course_code || "Curso"}" class="w-full aspect-[3/2] rounded object-cover object-top mb-4 bg-global-bg" loading="lazy" />`
              : `<div class="w-full aspect-[3/2] rounded bg-global-bg mb-4"></div>`
          }

          <div class="flex items-center pr-2 justify-between -mt-2">
            <span class="text-base md:text-lg font-semibold text-global-text">${sheet.course_name || sheet.course_code || "Curso"}</span>
            ${
              sheet.solution_kind
                ? `<span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-global-primary"><span class="block h-1.5 w-2.5 rounded-sm border-b-[3px] border-l-[3px] border-global-text" style="transform: rotate(-45deg) translate(-1px, -1px);"></span></span>`
                : `<span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-global-border"><span class="block h-0.5 w-2.5 rounded-full bg-white/50"></span></span>`
            }
          </div>
          <div class="flex items-center justify-between gap-2 pr-2 text-sm md:text-base">
            <span class="font-semibold text-global-text-muted">${sheet.exam_type ?? ""}</span>
            <span class="text-global-text-muted">${sheet.cycle ?? ""}</span>
          </div>
        </a>
      `;
      grid.appendChild(card);
    });

    grid.querySelectorAll("[data-remove-id]").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const target = e.currentTarget;
        const id = Number(target?.dataset.removeId);
        if (!Number.isInteger(id)) return;
        toggleFavorite(id);
        target?.closest("article")?.remove();
        if (grid.children.length === 0) {
          emptyState?.classList.remove("hidden");
          grid.classList.add("hidden");
        }
      });
    });
  }

  loadSaved();
  window.addEventListener("favorites:updated", loadSaved);
</script>
