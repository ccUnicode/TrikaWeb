---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import type { CourseSummary } from "../lib/data";
import { getCourses } from "../lib/data";

const courses: CourseSummary[] = await getCourses();
---

<Layout
  title="Cursos - TrikaWeb"
  description="Explora todos los cursos de la UNI. Encuentra planchas, exámenes pasados y profesores por curso."
>
  <main class="mx-auto max-w-screen-xl px-4 sm:px-6 lg:px-12 py-10 space-y-8">
    <header
      class="flex flex-col md:flex-row md:items-center justify-between gap-4"
    >
      <div>
        <h1 class="text-3xl font-bold text-global-text">Cursos</h1>
        <p class="text-global-text-muted mt-2">
          Explorar cursos para ver planchas y profesores relacionados.
        </p>
      </div>

      <div class="relative w-full md:w-96">
        <label for="search-course" class="sr-only">Buscar curso</label>
        <input
          type="search"
          id="search-course"
          placeholder="Buscar por código o nombre..."
          class="w-full rounded-full bg-global-surface border border-global-border px-4 py-2.5 text-global-text placeholder:text-global-text-muted focus:border-global-primary focus:outline-none focus:ring-1 focus:ring-global-primary"
          autocomplete="off"
        />
        <svg
          class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-global-text-muted"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </header>

    <div id="pagination-container" class="flex justify-center gap-2 mb-6">
      <!-- Los botones de paginación se generarán dinámicamente -->
    </div>

    {
      courses.length === 0 ? (
        <p class="text-center text-global-text-muted py-10">
          Aún no hay cursos registrados.
        </p>
      ) : (
        <div
          id="courses-grid"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 min-h-[720px] content-start"
        >
          {courses.map((course) => (
            <article
              class="course-item"
              data-name={course.name}
              data-code={course.code}
            >
              <a
                href={`/curso/${course.code}`}
                class="group flex h-full flex-col justify-between rounded-2xl border border-transparent bg-global-surface p-6 shadow-sm transition-all hover:border-global-primary/40 hover:shadow-lg hover:-translate-y-1"
              >
                <div>
                  <div class="flex items-start justify-between gap-3">
                    <h2 class="text-lg font-bold text-global-text group-hover:text-global-primary transition-colors leading-tight">
                      {course.name}
                    </h2>
                    <span class="shrink-0 text-sm font-semibold text-global-primary tracking-[0.2em]">
                      {course.code}
                    </span>
                  </div>
                </div>

                <div class="mt-6 flex items-center justify-between border-t border-global-border-subtle pt-4 text-sm text-global-text-muted">
                  <div class="flex items-center gap-2">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-4 w-4"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      />
                    </svg>
                    <span>
                      {course.sheetCount}{" "}
                      {course.sheetCount === 1 ? "plancha" : "planchas"}
                    </span>
                  </div>

                  <svg
                    class="h-5 w-5 text-global-primary transition-transform group-hover:translate-x-1"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M17 8l4 4m0 0l-4 4m4-4H3"
                    />
                  </svg>
                </div>
              </a>
            </article>
          ))}
        </div>
      )
    }

    <p id="no-results" class="hidden text-center text-global-text-muted py-10">
      No se encontraron cursos que coincidan con tu búsqueda.
    </p>
  </main>
</Layout>

<script>
  const normalize = (value = "") =>
    value
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .trim();

  const input = document.getElementById("search-course") as HTMLInputElement;
  const grid = document.getElementById("courses-grid");
  const noResults = document.getElementById("no-results");
  const paginationContainer = document.getElementById("pagination-container");
  const items = Array.from(
    document.querySelectorAll(".course-item"),
  ) as HTMLElement[];

  const ITEMS_PER_PAGE = 12; // 4 filas x 3 columnas
  let currentPage = 1;

  function updatePagination(filteredItems: HTMLElement[]) {
    if (!paginationContainer) return;

    const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
    paginationContainer.innerHTML = "";

    if (filteredItems.length <= ITEMS_PER_PAGE) {
      paginationContainer.classList.add("hidden");
      return;
    }
    paginationContainer.classList.remove("hidden");

    const createButton = (
      label: string,
      page: number,
      active: boolean = false,
      disabled: boolean = false,
      isArrow: boolean = false,
    ) => {
      const button = document.createElement("button");
      button.innerHTML = label;
      button.disabled = disabled;

      if (isArrow) {
        button.className = `flex items-center justify-center p-1 transition-colors ${
          disabled
            ? "text-global-text/20 cursor-not-allowed"
            : "text-global-text hover:text-global-primary cursor-pointer"
        }`;
      } else {
        button.className = `px-3 py-1 rounded-md text-sm font-medium transition-all ${
          disabled
            ? "opacity-30 cursor-not-allowed"
            : active
              ? "bg-global-primary text-white shadow-sm"
              : "bg-global-surface border border-global-border text-global-text hover:border-global-primary/50"
        }`;
      }

      if (!disabled) {
        button.addEventListener("click", () => {
          currentPage = page;
          const currentFilteredItems = getFilteredItems();
          applyPagination(currentFilteredItems);
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      }
      return button;
    };

    // Botón Anterior
    paginationContainer.appendChild(
      createButton(
        `
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
    `,
        currentPage - 1,
        false,
        currentPage === 1,
        true,
      ),
    );

    // Lógica de páginas a mostrar
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);

    if (endPage - startPage < 4) {
      startPage = Math.max(1, endPage - 4);
    }

    if (startPage > 1) {
      paginationContainer.appendChild(createButton("1", 1));
      if (startPage > 2) {
        const dots = document.createElement("span");
        dots.textContent = "...";
        dots.className = "text-global-text-muted px-1 self-end";
        paginationContainer.appendChild(dots);
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      paginationContainer.appendChild(
        createButton(i.toString(), i, i === currentPage),
      );
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        const dots = document.createElement("span");
        dots.textContent = "...";
        dots.className = "text-global-text-muted px-1 self-end";
        paginationContainer.appendChild(dots);
      }
      paginationContainer.appendChild(
        createButton(totalPages.toString(), totalPages),
      );
    }

    // Botón Siguiente
    paginationContainer.appendChild(
      createButton(
        `
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
    `,
        currentPage + 1,
        false,
        currentPage === totalPages,
        true,
      ),
    );
  }

  function applyPagination(filteredItems: HTMLElement[]) {
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    const endIndex = startIndex + ITEMS_PER_PAGE;

    items.forEach((item) => {
      item.classList.add("hidden");
    });

    filteredItems.slice(startIndex, endIndex).forEach((item) => {
      item.classList.remove("hidden");
    });

    updatePagination(filteredItems);
  }

  function getFilteredItems() {
    const term = normalize(input?.value || "");
    return items.filter((item) => {
      const name = normalize(item.dataset.name || "");
      const code = normalize(item.dataset.code || "");
      return !term || name.includes(term) || code.includes(term);
    });
  }

  if (input && grid) {
    input.addEventListener("input", () => {
      currentPage = 1;
      const filteredItems = getFilteredItems();

      if (filteredItems.length === 0) {
        grid.classList.add("hidden");
        noResults?.classList.remove("hidden");
        if (paginationContainer) paginationContainer.innerHTML = "";
      } else {
        grid.classList.remove("hidden");
        noResults?.classList.add("hidden");
        applyPagination(filteredItems);
      }
    });

    // Initial load
    applyPagination(items);
  }
</script>
