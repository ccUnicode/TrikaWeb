---
export const prerender = false;
import "../../styles/global.css";
import Layout from "../../layouts/Layout.astro";
import SheetRating from "../../components/SheetRating.astro";
import { supabaseAdmin } from "../../lib/supabaseAdmin";

const sheetId = Number(Astro.params.id);
if (!sheetId) {
  return Astro.redirect("/cursos");
}

const supa = supabaseAdmin;
const { data: sheet, error } = await supa
  .from("sheets")
  .select(
    `
    id,
    exam_type,
    cycle,
    teacher_hint,
    avg_difficulty,
    rating_count,
    view_count,
    exam_storage_path,
    solution_kind,
    solution_storage_path,
    solution_video_url,
    thumb_storage_path,
    courses:course_id (code,name)
  `,
  )
  .eq("id", sheetId)
  .single();

if (error || !sheet) {
  return Astro.redirect("/cursos");
}

const course = Array.isArray(sheet.courses) ? sheet.courses[0] : sheet.courses;
const courseCode = course?.code ?? "Curso";
const courseName = course?.name ?? "Curso";
const headerTitle =
  `${courseCode} - ${sheet.exam_type || "Plancha"} ${sheet.cycle || ""}`.trim();
const description =
  sheet.teacher_hint ||
  `${sheet.exam_type || "Evaluacion"} - ${sheet.cycle || "Sin ciclo"}`;

let examUrl: string | null = null;
if (sheet.exam_storage_path) {
  const { data } = await supa.storage
    .from("exams")
    .createSignedUrl(sheet.exam_storage_path, 600);
  examUrl = data?.signedUrl ?? null;
}

let solutionUrl: string | null = null;
if (sheet.solution_kind === "pdf" && sheet.solution_storage_path) {
  const { data } = await supa.storage
    .from("solutions")
    .createSignedUrl(sheet.solution_storage_path, 600);
  solutionUrl = data?.signedUrl ?? null;
}

let thumbUrl: string | null = null;
if (sheet.thumb_storage_path) {
  const { data } = await supa.storage
    .from("thumbnails")
    .createSignedUrl(sheet.thumb_storage_path, 600);
  thumbUrl = data?.signedUrl ?? null;
}

function getYouTubeId(url: string) {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return match && match[2].length === 11 ? match[2] : null;
}
---

<Layout title={headerTitle}>
  <main class="mx-auto max-w-screen-xl px-4 sm:px-6 lg:px-12 py-10 space-y-8">
    <header class="space-y-4 border-b border-global-border/50 pb-6">
      <!-- Main header grid: title & info on left, buttons on right -->
      <div
        class="grid grid-cols-1 lg:grid-cols-[1fr_auto] gap-4 lg:gap-8 items-start"
      >
        <!-- Left side: Title and metadata -->
        <div class="space-y-3">
          <h1 class="text-3xl font-bold text-global-text">
            {courseCode} - {courseName}
          </h1>
          <div
            class="flex flex-wrap items-center gap-3 text-sm text-global-text-muted"
          >
            <span
              class="rounded-full bg-global-surface px-3 py-1 font-semibold text-global-text"
            >
              {sheet.exam_type} - {sheet.cycle}
            </span>
            {
              sheet.view_count !== null && (
                <span>
                  Vistas: <strong>{sheet.view_count}</strong>
                </span>
              )
            }
            {
              sheet.rating_count !== null && (
                <span>
                  Votos: <strong>{sheet.rating_count}</strong>
                </span>
              )
            }
          </div>
          {
            sheet.teacher_hint &&
              sheet.teacher_hint.toLowerCase() !== "todos los profesores" &&
              sheet.teacher_hint.toLowerCase() !== "todos" && (
                <p class="text-sm text-global-text-muted">
                  <span class="text-global-text/70">Profesor:</span>{" "}
                  {sheet.teacher_hint}
                </p>
              )
          }
        </div>

        <!-- Right side: Action buttons -->
        <div class="flex flex-wrap gap-3 items-center">
          <!-- Save/Favorite Button -->
          <button
            id="favorite-btn"
            data-sheet-id={sheet.id}
            type="button"
            class="inline-flex items-center justify-center gap-2 rounded-full border-2 border-global-border hover:border-global-primary px-4 py-2 text-sm font-semibold text-global-text transition-all group cursor-pointer"
            title="Guardar plancha"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="favorite-icon transition-all"
            >
              <path
                d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"
              ></path>
            </svg>
            <span class="favorite-text">Guardar</span>
          </button>

          {
            examUrl && (
              <a
                id="action-download-btn"
                href={`/api/sheets/${sheet.id}/file?mode=download`}
                data-exam-href={`/api/sheets/${sheet.id}/file?mode=download`}
                data-solution-href={
                  sheet.solution_kind === "pdf" && sheet.solution_storage_path
                    ? `/api/sheets/${sheet.id}/file?mode=download&type=solution`
                    : ""
                }
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center gap-2 rounded-full bg-global-primary hover:bg-global-primary-hover px-4 py-2 text-sm font-semibold text-black transition-colors"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                  <polyline points="7 10 12 15 17 10" />
                  <line x1="12" y1="15" x2="12" y2="3" />
                </svg>
                <span id="action-download-text">Descargar examen</span>
              </a>
            )
          }
          {
            (solutionUrl ||
              (sheet.solution_kind === "video" &&
                sheet.solution_video_url)) && (
              <button
                id="view-solution-btn"
                data-solution-url={solutionUrl}
                data-video-url={sheet.solution_video_url}
                data-solution-type={sheet.solution_kind}
                data-sheet-id={sheet.id}
                type="button"
                class="inline-flex items-center justify-center gap-2 rounded-full bg-global-primary hover:bg-global-primary-hover px-4 py-2 text-sm font-semibold text-black transition-colors cursor-pointer"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                  <polyline points="14 2 14 8 20 8" />
                  <line x1="16" y1="13" x2="8" y2="13" />
                  <line x1="16" y1="17" x2="8" y2="17" />
                  <polyline points="10 9 9 9 8 9" />
                </svg>
                <span>Ver solucionario</span>
              </button>
            )
          }

          <button
            id="view-exam-btn"
            data-exam-url={examUrl}
            type="button"
            class="hidden items-center justify-center gap-2 rounded-full bg-global-primary hover:bg-global-primary-hover px-4 py-2 text-sm font-semibold text-black transition-colors cursor-pointer"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
              ></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>Ver examen</span>
          </button>
        </div>
      </div>
    </header>

    <section class="space-y-6">
      <div class="space-y-6">
        <!-- Visor de Plancha (PDF) -->
        <div
          class="rounded-2xl border border-global-border-subtle bg-global-surface p-2 sm:p-4 max-w-4xl mx-auto"
        >
          {
            examUrl ? (
              <div
                id="viewer-container"
                class="relative w-full overflow-hidden rounded-xl bg-black/40 shadow-lg min-h-[500px] sm:aspect-[3/4] sm:min-h-0"
              >
                <iframe
                  id="pdf-viewer-iframe"
                  src={`${examUrl}#toolbar=0&navpanes=0&view=FitH`}
                  data-exam-url={examUrl}
                  class="absolute inset-0 h-full w-full rounded-xl border-0"
                  loading="lazy"
                  allowfullscreen
                />
              </div>
            ) : (
              <p class="rounded-xl border border-dashed border-global-border/50 bg-black/10 p-6 text-center text-global-text-muted">
                No pudimos generar el visor para esta plancha.
              </p>
            )
          }
        </div>
      </div>

      <div
        class="rounded-2xl border border-global-border-subtle bg-global-surface p-4 sm:p-6 max-w-4xl mx-auto"
      >
        <div class="space-y-4">
          <!-- Header: Evaluación y Ciclo -->
          <div class="flex items-center justify-between">
            <p class="text-sm text-global-text-muted">
              Evaluación: <span class="text-xl font-bold text-global-text"
                >{sheet.exam_type}</span
              >
            </p>
            <p class="text-sm text-global-text-muted">
              Ciclo: <span class="text-xl font-bold text-global-text"
                >{sheet.cycle}</span
              >
            </p>
          </div>
          {
            sheet.teacher_hint &&
              sheet.teacher_hint.toLowerCase() !== "todos los profesores" &&
              sheet.teacher_hint.toLowerCase() !== "todos" && (
                <p class="text-sm text-global-text-muted">
                  Profesor:{" "}
                  <span class="text-global-text">{sheet.teacher_hint}</span>
                </p>
              )
          }

          <!-- Derecha: Widget de votación -->
          <div class="rounded-xl bg-global-card p-4">
            <SheetRating
              sheetId={sheet.id}
              avg={sheet.avg_difficulty}
              count={sheet.rating_count}
            />
          </div>
        </div>
      </div>
    </section>
  </main>
</Layout>

<script>
  // Helper to extract ID for client-side usage if needed
  function getYouTubeId(url: string) {
    const regExp =
      /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return match && match[2].length === 11 ? match[2] : null;
  }

  // Handle solution/exam viewer switching
  function initViewerSwitcher() {
    const iframe = document.getElementById(
      "pdf-viewer-iframe",
    ) as HTMLIFrameElement;
    const container = document.getElementById("viewer-container");
    const solutionBtn = document.getElementById("view-solution-btn");
    const examBtn = document.getElementById("view-exam-btn");
    const downloadBtn = document.getElementById(
      "action-download-btn",
    ) as HTMLAnchorElement;
    const downloadText = document.getElementById("action-download-text");

    if (!iframe || !container) return;

    // Helper classes
    const pdfClasses = ["sm:aspect-[3/4]", "min-h-[500px]", "sm:min-h-0"];
    const videoClasses = ["aspect-video"];

    // Handle "Ver solucionario" button
    if (solutionBtn) {
      solutionBtn.addEventListener("click", () => {
        const solutionType = solutionBtn.getAttribute("data-solution-type");
        const solutionUrl = solutionBtn.getAttribute("data-solution-url");
        const videoUrl = solutionBtn.getAttribute("data-video-url");

        // Update download button logic
        if (downloadBtn && downloadText) {
          if (solutionType === "pdf") {
            const solHref = downloadBtn.dataset.solutionHref;
            if (solHref) {
              downloadBtn.href = solHref;
              downloadText.textContent = "Descargar sol.";
              downloadBtn.classList.remove("hidden");
              downloadBtn.classList.add("inline-flex");
            } else {
              // If pdf but no download link (should handle graceful or fallback)
              downloadBtn.classList.add("hidden");
              downloadBtn.classList.remove("inline-flex");
            }
          } else {
            // For video, hide download button
            downloadBtn.classList.add("hidden");
            downloadBtn.classList.remove("inline-flex");
          }
        }

        if (solutionType === "video" && videoUrl) {
          const videoId = getYouTubeId(videoUrl);
          if (videoId) {
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
            iframe.setAttribute(
              "allow",
              "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",
            );
            // Switch container to video mode
            container.classList.remove(...pdfClasses);
            container.classList.add(...videoClasses);
          }
        } else if (solutionUrl) {
          // Change iframe src to solution PDF
          iframe.src = `${solutionUrl}#toolbar=0&navpanes=0&view=FitH`;
          iframe.removeAttribute("allow");
          // Ensure container is in PDF mode
          container.classList.remove(...videoClasses);
          container.classList.add(...pdfClasses);
        } else {
          return;
        }

        // Toggle button visibility - use inline-flex when showing
        solutionBtn.classList.add("hidden");
        solutionBtn.classList.remove("inline-flex");
        if (examBtn) {
          examBtn.classList.remove("hidden");
          examBtn.classList.add("inline-flex");
        }
      });
    }

    // Handle "Ver examen" button
    if (examBtn) {
      examBtn.addEventListener("click", () => {
        const examUrl = examBtn.getAttribute("data-exam-url");

        // Reset download button
        if (downloadBtn && downloadText) {
          const examHref = downloadBtn.dataset.examHref;
          if (examHref) {
            downloadBtn.href = examHref;
            downloadText.textContent = "Descargar examen";
            downloadBtn.classList.remove("hidden");
            downloadBtn.classList.add("inline-flex");
          }
        }

        if (!examUrl) return;

        // Change iframe src back to exam PDF
        iframe.src = `${examUrl}#toolbar=0&navpanes=0&view=FitH`;
        iframe.removeAttribute("allow");

        // Ensure container is in PDF mode
        container.classList.remove(...videoClasses);
        container.classList.add(...pdfClasses);

        // Toggle button visibility - use inline-flex when showing
        examBtn.classList.add("hidden");
        examBtn.classList.remove("inline-flex");
        if (solutionBtn) {
          solutionBtn.classList.remove("hidden");
          solutionBtn.classList.add("inline-flex");
        }
      });
    }
  }

  document.addEventListener("astro:page-load", initViewerSwitcher);
  document.addEventListener("DOMContentLoaded", initViewerSwitcher);
</script>

<script>
  // Favorite/Save functionality
  function getFavorites() {
    try {
      const stored = localStorage.getItem("trikaweb:favorites");
      return stored ? JSON.parse(stored) : [];
    } catch {
      return [];
    }
  }

  function toggleFavorite(id: number) {
    const favs = getFavorites();
    const index = favs.indexOf(id);
    if (index >= 0) {
      favs.splice(index, 1);
    } else {
      favs.push(id);
    }
    localStorage.setItem("trikaweb:favorites", JSON.stringify(favs));
    window.dispatchEvent(
      new CustomEvent("favorites:updated", {
        detail: { id, active: index === -1 },
      }),
    );
    return index === -1; // returns true if now favorited
  }

  function initFavoriteButton() {
    const btn = document.getElementById("favorite-btn");
    if (!btn) return;

    const sheetId = Number(btn.getAttribute("data-sheet-id"));
    if (!sheetId) return;

    const icon = btn.querySelector(".favorite-icon");
    const text = btn.querySelector(".favorite-text");

    // Update UI based on current state
    function updateUI(isFavorited: boolean) {
      // btn is guaranteed to be non-null here due to early return check
      if (isFavorited) {
        icon?.setAttribute("fill", "currentColor");
        icon?.classList.add("text-red-500");
        if (text) text.textContent = "Guardado";
        btn!.classList.add("border-red-500", "text-red-500");
        btn!.classList.remove("border-global-border", "text-global-text");
      } else {
        icon?.setAttribute("fill", "none");
        icon?.classList.remove("text-red-500");
        if (text) text.textContent = "Guardar";
        btn!.classList.remove("border-red-500", "text-red-500");
        btn!.classList.add("border-global-border", "text-global-text");
      }
    }

    // Check initial state
    const favs = getFavorites();
    updateUI(favs.includes(sheetId));

    // Handle click
    btn.addEventListener("click", () => {
      const nowFavorited = toggleFavorite(sheetId);
      updateUI(nowFavorited);

      // Add a little animation
      btn.classList.add("scale-110");
      setTimeout(() => btn.classList.remove("scale-110"), 200);
    });
  }

  document.addEventListener("astro:page-load", initFavoriteButton);
  document.addEventListener("DOMContentLoaded", initFavoriteButton);
</script>

<script define:vars={{ sheetId }}>
  // Inlined ensureDeviceId to avoid module import issues with define:vars
  const DEVICE_STORAGE_KEY = "tw_device_id";
  function ensureDeviceId() {
    if (typeof window === "undefined") return "";
    let current = window.localStorage.getItem(DEVICE_STORAGE_KEY);
    if (!current) {
      current = crypto.randomUUID();
      window.localStorage.setItem(DEVICE_STORAGE_KEY, current);
    }
    return current;
  }

  const SHEET_ID = sheetId;

  const registerView = () => {
    const payload = JSON.stringify({
      device_id: ensureDeviceId(),
      type: "view",
    });
    const url = `/api/sheets/${SHEET_ID}/view`;

    if (navigator.sendBeacon) {
      navigator.sendBeacon(
        url,
        new Blob([payload], { type: "application/json" }),
      );
      return;
    }

    fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: payload,
      keepalive: true,
    }).catch(() => undefined);
  };

  if (typeof window !== "undefined") {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", registerView, {
        once: true,
      });
    } else {
      registerView();
    }
  }
</script>

<script>
  import { ensureDeviceId } from "../../lib/client/device";

  const highlight = (widget: Element, score: number) => {
    widget.querySelectorAll("[data-score]").forEach((btn) => {
      const val = Number((btn as HTMLElement).dataset.score);
      const active = val <= score;
      const svg = btn.querySelector("svg");
      if (svg) {
        if (active) {
          svg.classList.remove("star-inactive");
          svg.classList.add("fill-global-primary", "text-global-primary");
        } else {
          svg.classList.add("star-inactive");
          svg.classList.remove("fill-global-primary", "text-global-primary");
        }
      }
    });
  };

  const initRatings = () => {
    document.querySelectorAll("[data-rating-widget]").forEach((widget) => {
      const sheetId = widget.getAttribute("data-sheet-id");
      const valueEl = widget.querySelector("[data-rating-value]");
      const countEl = widget.querySelector("[data-rating-count]");
      const statusEl = widget.querySelector("[data-rating-status]");
      const initial = Number(widget.getAttribute("data-current-rating") || 0);
      highlight(widget, Math.round(initial));

      widget.querySelectorAll("[data-score]").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();
          const score = Number((btn as HTMLElement).dataset.score);
          if (!Number.isFinite(score) || !sheetId) return;
          highlight(widget, score);
          widget.classList.add("opacity-80", "pointer-events-none");
          try {
            const deviceId = ensureDeviceId();
            const response = await fetch(`/api/sheets/${sheetId}/rate`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ score, device_id: deviceId }),
            });
            if (!response.ok) {
              const error = await response.json().catch(() => ({}));
              if (statusEl) {
                statusEl.textContent = error?.error ?? "Error al enviar";
                statusEl.classList.add("text-red-400");
              }
              return;
            }
            const result = await response.json();
            const avg = result?.stats?.avg_difficulty ?? score;
            const count = result?.stats?.rating_count ?? 0;
            if (valueEl) valueEl.textContent = Number(avg).toFixed(2);
            if (countEl) countEl.textContent = count;
            // Mantenemos resaltado el voto del usuario para que vea el cambio
            highlight(widget, score);
            if (statusEl) {
              statusEl.textContent = "Voto guardado";
              statusEl.classList.remove("text-red-400");
            }
          } catch (err) {
            console.error(err);
            if (statusEl) {
              statusEl.textContent = "Error inesperado";
              statusEl.classList.add("text-red-400");
            }
          } finally {
            setTimeout(() => {
              widget.classList.remove("opacity-80", "pointer-events-none");
            }, 250);
          }
        });

        // Add hover effect
        btn.addEventListener("mouseenter", () => {
          const score = Number((btn as HTMLElement).dataset.score);
          highlight(widget, score);
        });
      });

      // Reset to current rating on mouse leave from widget
      widget.addEventListener("mouseleave", () => {
        highlight(widget, Math.round(initial));
      });
    });
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initRatings, {
      once: true,
    });
  } else {
    initRatings();
  }
</script>
