---
export const prerender = false;
import "../../styles/global.css";
import Layout from "../../layouts/Layout.astro";
import SheetRating from "../../components/SheetRating.astro";
import DownloadButton from "../../components/DownloadButton.astro";
import { supabaseAdmin } from "../../lib/supabase.server";

const sheetId = Number(Astro.params.id);
if (!sheetId) {
  return Astro.redirect("/cursos");
}

const supa = supabaseAdmin();
const { data: sheet, error } = await supa
  .from("sheets")
  .select(
    `
    id,
    exam_type,
    cycle,
    teacher_hint,
    avg_difficulty,
    rating_count,
    view_count,
    exam_storage_path,
    solution_kind,
    solution_storage_path,
    solution_video_url,
    thumb_storage_path,
    courses:course_id (code,name)
  `,
  )
  .eq("id", sheetId)
  .single();

if (error || !sheet) {
  return Astro.redirect("/cursos");
}

const course = Array.isArray(sheet.courses) ? sheet.courses[0] : sheet.courses;
const courseCode = course?.code ?? "Curso";
const courseName = course?.name ?? "Curso";
const headerTitle =
  `${courseCode} - ${sheet.exam_type || "Plancha"} ${sheet.cycle || ""}`.trim();
const description =
  sheet.teacher_hint ||
  `${sheet.exam_type || "Evaluacion"} - ${sheet.cycle || "Sin ciclo"}`;

let examUrl: string | null = null;
if (sheet.exam_storage_path) {
  const { data } = await supa.storage
    .from("exams")
    .createSignedUrl(sheet.exam_storage_path, 600);
  examUrl = data?.signedUrl ?? null;
}

let solutionUrl: string | null = null;
if (sheet.solution_kind === "pdf" && sheet.solution_storage_path) {
  const { data } = await supa.storage
    .from("solutions")
    .createSignedUrl(sheet.solution_storage_path, 600);
  solutionUrl = data?.signedUrl ?? null;
}

let thumbUrl: string | null = null;
if (sheet.thumb_storage_path) {
  const { data } = await supa.storage
    .from("thumbnails")
    .createSignedUrl(sheet.thumb_storage_path, 600);
  thumbUrl = data?.signedUrl ?? null;
}

function getYouTubeId(url: string) {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return match && match[2].length === 11 ? match[2] : null;
}
---

<Layout title={headerTitle}>
  <main class="mx-auto max-w-screen-xl px-4 sm:px-6 lg:px-12 py-10 space-y-8">
    <header class="space-y-3 border-b border-global-border/50 pb-6">
      <p class="text-sm uppercase tracking-[0.3em] text-global-text-muted">
        Plancha
      </p>
      <h1 class="text-3xl font-bold text-global-text">
        {courseCode} - {courseName}
      </h1>
      <div
        class="flex flex-wrap items-center gap-3 text-sm text-global-text-muted"
      >
        <span
          class="rounded-full bg-global-surface px-3 py-1 font-semibold text-global-text"
        >
          {sheet.exam_type} - {sheet.cycle}
        </span>
        {
          sheet.view_count !== null && (
            <span>
              Vistas: <strong>{sheet.view_count}</strong>
            </span>
          )
        }
        {
          sheet.rating_count !== null && (
            <span>
              Votos: <strong>{sheet.rating_count}</strong>
            </span>
          )
        }
      </div>
      <p class="text-base text-global-text-muted">{description}</p>

      <div class="flex flex-wrap gap-3">
        <DownloadButton sheetId={sheet.id} downloadUrl={examUrl || undefined} />
        {
          solutionUrl && (
            <a
              href={solutionUrl}
              target="_blank"
              rel="noreferrer"
              class="inline-flex items-center justify-center rounded-full border border-global-border px-4 py-2 text-sm font-semibold text-global-text hover:border-global-primary"
            >
              Ver solucionario
            </a>
          )
        }
      </div>
    </header>

    <section class="space-y-6">
      <div class="space-y-6">
        <!-- Visor de Plancha (PDF) -->
        <div
          class="rounded-2xl border border-global-border-subtle bg-global-surface/60 p-2 sm:p-4 max-w-4xl mx-auto"
        >
          {
            examUrl ? (
              <div class="relative aspect-[3/4] w-full overflow-hidden rounded-xl bg-black/40 shadow-lg">
                <iframe
                  src={`${examUrl}#toolbar=0&navpanes=0`}
                  class="absolute inset-0 h-full w-full rounded-xl border-0"
                  loading="lazy"
                  allowfullscreen
                />
              </div>
            ) : (
              <p class="rounded-xl border border-dashed border-global-border/50 bg-black/10 p-6 text-center text-global-text-muted">
                No pudimos generar el visor para esta plancha.
              </p>
            )
          }
        </div>

        <!-- Solucionario en Video -->
        {
          sheet.solution_kind === "video" && sheet.solution_video_url && (
            <div class="rounded-2xl border border-global-border/40 bg-global-surface/60 p-4 sm:p-6 space-y-4 max-w-4xl mx-auto">
              <h3 class="text-xl font-semibold text-global-text flex items-center gap-2">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="text-red-500"
                >
                  <>
                    <polygon points="23 7 16 12 23 17 23 7" />
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
                  </>
                </svg>
                Solucionario en Video
              </h3>

              <div
                class="video-player-container relative aspect-video w-full overflow-hidden rounded-xl bg-black shadow-lg group cursor-pointer"
                data-video-url={sheet.solution_video_url}
              >
                {/* Thumbnail Image or Fallback */}
                <img
                  src={
                    thumbUrl ||
                    `https://img.youtube.com/vi/${getYouTubeId(sheet.solution_video_url)}/maxresdefault.jpg`
                  }
                  alt="Video Thumbnail"
                  class="absolute inset-0 h-full w-full object-cover opacity-80 transition-opacity group-hover:opacity-100"
                  onerror="this.src='https://img.youtube.com/vi/${getYouTubeId(sheet.solution_video_url)}/hqdefault.jpg'"
                />

                {/* Play Button Overlay */}
                <div class="absolute inset-0 flex items-center justify-center">
                  <div class="flex h-16 w-16 items-center justify-center rounded-full bg-red-600/90 text-white shadow-xl transition-transform group-hover:scale-110">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="32"
                      height="32"
                      viewBox="0 0 24 24"
                      fill="currentColor"
                      stroke="none"
                    >
                      <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                  </div>
                </div>
              </div>
            </div>
          )
        }
      </div>

      <div
        class="space-y-4 rounded-2xl border border-global-border-subtle bg-global-surface/60 p-4 sm:p-6 lg:flex lg:items-center lg:justify-between lg:gap-6 max-w-4xl mx-auto"
      >
        <div class="space-y-2">
          <p class="text-xs uppercase tracking-[0.2em] text-global-text-muted">
            Evaluacion
          </p>
          <p class="text-xl font-semibold text-global-text">
            {sheet.exam_type}
          </p>
          <p class="text-sm text-global-text-muted">Ciclo: {sheet.cycle}</p>
          {
            sheet.teacher_hint && (
              <p class="text-sm text-global-text-muted">
                Profesor: {sheet.teacher_hint}
              </p>
            )
          }
        </div>

        <div class="lg:ml-auto lg:min-w-[280px]">
          <SheetRating
            sheetId={sheet.id}
            avg={sheet.avg_difficulty}
            count={sheet.rating_count}
          />
        </div>
      </div>
    </section>
  </main>
</Layout>

<script>
  // Helper to extract ID for client-side usage if needed
  function getYouTubeId(url: string) {
    const regExp =
      /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return match && match[2].length === 11 ? match[2] : null;
  }

  function initVideoPlayers() {
    const containers = document.querySelectorAll(".video-player-container");
    containers.forEach((container) => {
      container.addEventListener("click", () => {
        const url = container.getAttribute("data-video-url");
        if (!url) return;

        const videoId = getYouTubeId(url);
        if (!videoId) return;

        const iframe = document.createElement("iframe");
        iframe.setAttribute(
          "src",
          `https://www.youtube.com/embed/${videoId}?autoplay=1`,
        );
        iframe.setAttribute(
          "class",
          "absolute inset-0 h-full w-full rounded-xl border-0",
        );
        iframe.setAttribute(
          "allow",
          "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture",
        );
        iframe.setAttribute("allowfullscreen", "true");

        container.innerHTML = "";
        container.appendChild(iframe);
        container.classList.remove("cursor-pointer", "group");
      });
    });
  }

  document.addEventListener("astro:page-load", initVideoPlayers);
  document.addEventListener("DOMContentLoaded", initVideoPlayers);
</script>

<script type="module">
  import { ensureDeviceId } from "../../lib/client/device";
  const SHEET_ID = { sheetId };

  const registerView = () => {
    const payload = JSON.stringify({
      device_id: ensureDeviceId(),
      type: "view",
    });
    const url = `/api/sheets/${SHEET_ID}/view`;

    if (navigator.sendBeacon) {
      navigator.sendBeacon(
        url,
        new Blob([payload], { type: "application/json" }),
      );
      return;
    }

    fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: payload,
      keepalive: true,
    }).catch(() => undefined);
  };

  if (typeof window !== "undefined") {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", registerView, {
        once: true,
      });
    } else {
      registerView();
    }
  }
</script>

<script type="module">
  import { ensureDeviceId } from "../../lib/client/device";

  const highlight = (widget, score) => {
    widget.querySelectorAll("[data-score]").forEach((btn) => {
      const val = Number(btn.dataset.score);
      const active = val <= score;
      btn.classList.toggle("bg-global-primary", active);
      btn.classList.toggle("text-black", active);
      btn.classList.toggle("text-global-text-muted", !active);
      btn.classList.toggle("ring-2", active);
      btn.classList.toggle("ring-global-primary/70", active);
    });
  };

  const initRatings = () => {
    document.querySelectorAll("[data-rating-widget]").forEach((widget) => {
      const sheetId = widget.getAttribute("data-sheet-id");
      const valueEl = widget.querySelector("[data-rating-value]");
      const countEl = widget.querySelector("[data-rating-count]");
      const statusEl = widget.querySelector("[data-rating-status]");
      const initial = Number(widget.getAttribute("data-current-rating") || 0);
      highlight(widget, Math.round(initial));

      widget.querySelectorAll("[data-score]").forEach((btn) => {
        btn.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();
          const score = Number(btn.dataset.score);
          if (!Number.isFinite(score) || !sheetId) return;
          highlight(widget, score);
          widget.classList.add("opacity-80", "pointer-events-none");
          try {
            const deviceId = ensureDeviceId();
            const response = await fetch(`/api/sheets/${sheetId}/rate`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ score, device_id: deviceId }),
            });
            if (!response.ok) {
              const error = await response.json().catch(() => ({}));
              if (statusEl) {
                statusEl.textContent = error?.error ?? "Error al enviar";
                statusEl.classList.add("text-red-400");
              }
              return;
            }
            const result = await response.json();
            const avg = result?.stats?.avg_difficulty ?? score;
            const count = result?.stats?.rating_count ?? 0;
            if (valueEl) valueEl.textContent = Number(avg).toFixed(2);
            if (countEl) countEl.textContent = count;
            // Mantenemos resaltado el voto del usuario para que vea el cambio
            highlight(widget, score);
            if (statusEl) {
              statusEl.textContent = "Voto guardado";
              statusEl.classList.remove("text-red-400");
            }
          } catch (err) {
            console.error(err);
            if (statusEl) {
              statusEl.textContent = "Error inesperado";
              statusEl.classList.add("text-red-400");
            }
          } finally {
            setTimeout(() => {
              widget.classList.remove("opacity-80", "pointer-events-none");
            }, 250);
          }
        });
      });
    });
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initRatings, { once: true });
  } else {
    initRatings();
  }
</script>
