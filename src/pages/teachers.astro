---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import TeacherCard from "../components/TeacherCard.astro";
import { getTeachers } from "../lib/data";

const teachers = await getTeachers();
---

<Layout title="Profesores">
  <main class="mx-auto max-w-screen-xl px-4 sm:px-6 lg:px-12 py-10 space-y-8">
    <header
      class="flex flex-col md:flex-row md:items-center justify-between gap-4"
    >
      <div>
        <h1 class="text-3xl font-bold text-global-text">Profesores</h1>
        <p class="text-global-text-muted mt-2">
          Encuentra a tu profesor y revisa sus calificaciones.
        </p>
      </div>

      <div class="relative w-full md:w-96">
        <label for="search-teacher" class="sr-only">Buscar profesor</label>
        <input
          type="search"
          id="search-teacher"
          placeholder="Buscar por nombre o curso..."
          class="w-full rounded-full bg-global-surface border border-global-border px-4 py-2.5 text-global-text placeholder:text-global-text-muted focus:border-global-primary focus:outline-none focus:ring-1 focus:ring-global-primary"
          autocomplete="off"
        />
        <svg
          class="absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-global-text-muted"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </header>

    {
      teachers.length === 0 ? (
        <p class="text-center text-global-text-muted py-10">
          No hay profesores registrados.
        </p>
      ) : (
        <div
          id="teachers-grid"
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
        >
          {teachers.map((teacher) => (
            <article
              class="teacher-item"
              data-name={teacher.full_name}
              data-courses={(teacher.courses || [])
                .map((c) => `${c.code} ${c.name}`)
                .join(",")}
            >
              <TeacherCard
                name={teacher.full_name}
                role={teacher.courses?.[0]?.code ?? "Profesor"}
                courses={teacher.courses?.map((c) => c.code) ?? []}
                modality={teacher.courses?.[0]?.modality ?? undefined}
                rating={teacher.avg_overall ?? 0}
                avatarSrc={teacher.avatar_url || "/img/fallback_teacher.jpeg"}
                href={`/teachers/${teacher.id}`}
                buttonLabel="Ver perfil"
              />
            </article>
          ))}
        </div>
      )
    }

    <p id="no-results" class="hidden text-center text-global-text-muted py-10">
      No se encontraron profesores que coincidan con tu b√∫squeda.
    </p>
  </main>
</Layout>

<script>
  const normalize = (value = "") =>
    value
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .trim();

  const input = document.getElementById("search-teacher");
  const grid = document.getElementById("teachers-grid");
  const noResults = document.getElementById("no-results");
  const items = Array.from(document.querySelectorAll(".teacher-item"));

  if (input && grid) {
    input.addEventListener("input", (e) => {
      const target = e.target;
      const term = normalize(
        target && "value" in target ? String(target.value) : "",
      );
      let visibleCount = 0;

      items.forEach((item) => {
        const el = item as HTMLElement;
        const name = normalize(el.dataset.name || "");
        const courses = normalize(el.dataset.courses || "");
        const matches = !term || name.includes(term) || courses.includes(term);
        el.classList.toggle("hidden", !matches);
        if (matches) visibleCount++;
      });

      if (visibleCount === 0) {
        grid.classList.add("hidden");
        noResults?.classList.remove("hidden");
      } else {
        grid.classList.remove("hidden");
        noResults?.classList.add("hidden");
      }
    });
  }
</script>
