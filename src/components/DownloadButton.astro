---
export interface Props {
  sheetId: number;
  label?: string;
  variant?: 'primary' | 'secondary';
  downloadUrl?: string;
}
const { sheetId, label = 'Ver / Descargar', variant = 'primary', downloadUrl } = Astro.props;
const baseClasses = 'inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-semibold transition';
const variantClass = variant === 'secondary'
  ? 'border border-global-border text-global-text hover:border-global-primary'
  : 'bg-global-primary text-black hover:bg-global-primary-hover';
const targetHref = downloadUrl ?? (sheetId ? `/api/sheets/${sheetId}/file` : '#');
---
<a
  href={targetHref}
  target="_blank"
  rel="noreferrer"
  class={`${baseClasses} ${variantClass}`}
  data-sheet-download
  data-sheet-id={sheetId}
>
  {label}
</a>

<script type="module">
import { ensureDeviceId } from '/src/lib/client/device';

const initDownload = (el) => {
  if (el.dataset.bound === 'true') return;
  el.dataset.bound = 'true';
  el.addEventListener('click', () => {
    const sheetId = el.dataset.sheetId;
    if (!sheetId) return;
    const deviceId = ensureDeviceId();
    const payload = JSON.stringify({ device_id: deviceId, type: 'download' });
    const viewUrl = `/api/sheets/${sheetId}/view`;
    if (navigator.sendBeacon) {
      navigator.sendBeacon(viewUrl, new Blob([payload], { type: 'application/json' }));
      return;
    }
    fetch(viewUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: payload,
      keepalive: true,
    }).catch(() => undefined);
  });
};

if (typeof window !== 'undefined') {
  document.querySelectorAll('[data-sheet-download]').forEach(initDownload);
}
</script>
