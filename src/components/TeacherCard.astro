---
import IconStar from "./icons/IconStar.astro";
import TeacherAvatar from "./TeacherAvatar.astro";

export interface Props {
  name: string;
  role: string;
  rating?: number; // 0-5
  avatarSrc?: string | null | undefined;
  href?: string;
  class?: string;
  alt?: string;
  ratingStyle?: "stars" | "squares";
  showButton?: boolean; // force show CTA even without href/openId
  buttonLabel?: string;
  openId?: string; // optional button id to integrate with modals
  modality?: string;
  variant?: "compact" | "detailed"; // New prop for layout variant
  courses?: string[];
}

const {
  name,
  role,
  rating = 0,
  avatarSrc,
  href,
  class: extraClass = "",
  alt,
  ratingStyle = "stars",
  showButton = false,
  buttonLabel = "Ver perfil",
  openId,
  modality,
  variant = "compact",
  courses,
} = Astro.props as Props;

const safeRating = Math.max(0, Math.min(5, Math.round(rating)));
const stars = Array.from({ length: 5 });

// Different wrapper classes based on variant
const wrapperClass =
  variant === "detailed"
    ? `h-full bg-global-card rounded-xl p-6 flex flex-col items-center gap-4 text-center${extraClass ? " " + extraClass : ""}`
    : `h-full bg-global-card rounded-xl px-2 lg:px-0 py-6 flex flex-col items-center gap-4 text-center${extraClass ? " " + extraClass : ""}`;
---

{
  href ? (
    <a
      href={href}
      class={
        wrapperClass +
        " focus:outline-none focus-visible:ring-2 focus-visible:ring-[#51A624]"
      }
      aria-label={`Ver perfil de ${name}`}
    >
      <TeacherAvatar name={name} avatarSrc={avatarSrc} size="md" />

      <div class="space-y-2 w-full flex-1 flex flex-col justify-center">
        <h3
          class="text-xl md:text-2xl font-semibold text-global-text line-clamp-2 px-4"
          title={name}
        >
          {name}
        </h3>
        {variant === "detailed" ? (
          <p class="text-sm text-global-text-muted leading-relaxed max-h-24 overflow-y-auto px-2 teacher-scroll text-justify">
            {role}
          </p>
        ) : (
          <div class="flex flex-col gap-2 w-full px-4 min-h-[60px]">
            <div class="flex items-center justify-center gap-2 flex-wrap text-center">
              {courses && courses.length > 0 ? (
                courses.map((course) => (
                  <span class="inline-flex items-center rounded-md border border-global-border px-2 py-0.5 text-xs font-medium text-global-text-muted hover:border-global-primary transition-colors">
                    {course}
                  </span>
                ))
              ) : (
                <span class="text-sm md:text-base font-medium text-global-text-muted">
                  {role}
                </span>
              )}
            </div>

            {modality && (
              <div class="flex items-center justify-center gap-2 flex-wrap">
                {modality.includes("T") && (
                  <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-200">
                    Teoría
                  </span>
                )}
                {modality.includes("P") && (
                  <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full dark:bg-green-900 dark:text-green-200">
                    Práctica
                  </span>
                )}
                {modality.includes("L") && (
                  <span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full dark:bg-purple-900 dark:text-purple-200">
                    Lab
                  </span>
                )}
              </div>
            )}
          </div>
        )}
      </div>

      <div
        class="flex items-center gap-2"
        aria-label={`Calificación: ${safeRating} de 5`}
      >
        {ratingStyle === "stars"
          ? stars.map((_, i) => (
              <IconStar
                size={18}
                filled={i < safeRating}
                class="text-global-primary"
              />
            ))
          : stars.map((_, i) => (
              <span
                class={
                  i < safeRating
                    ? "block h-3.5 w-3.5 rounded-sm bg-global-primary"
                    : "block h-3.5 w-3.5 rounded-sm border border-global-border"
                }
              />
            ))}
      </div>

      <div class="pt-2">
        {openId ? (
          <button
            id={openId}
            class="inline-flex items-center justify-center rounded-2xl bg-global-primary hover:bg-global-primary-hover px-4 py-2 text-[15px] font-semibold text-global-text focus:outline-none focus-visible:ring-2 focus-visible:ring-[#51A624]"
          >
            {buttonLabel}
          </button>
        ) : showButton ? (
          <span class="inline-flex items-center justify-center rounded-2xl bg-global-primary px-4 py-2 text-[15px] font-semibold text-global-text">
            {buttonLabel}
          </span>
        ) : null}
      </div>
    </a>
  ) : (
    <div class={wrapperClass}>
      <TeacherAvatar name={name} avatarSrc={avatarSrc} size="md" />

      <div class="space-y-2 w-full flex-1 flex flex-col justify-center">
        <h3
          class="text-xl md:text-2xl font-semibold text-global-text line-clamp-2 px-4"
          title={name}
        >
          {name}
        </h3>
        {variant === "detailed" ? (
          <p class="text-sm text-global-text-muted leading-relaxed max-h-24 overflow-y-auto px-2 teacher-scroll text-justify">
            {role}
          </p>
        ) : (
          <div class="flex flex-col gap-2 w-full px-4 min-h-[60px]">
            <div class="flex items-center justify-center gap-2 flex-wrap text-center">
              {courses && courses.length > 0 ? (
                courses.map((course) => (
                  <span class="inline-flex items-center rounded-md border border-global-border px-2 py-0.5 text-xs font-medium text-global-text-muted hover:border-global-primary transition-colors">
                    {course}
                  </span>
                ))
              ) : (
                <span class="text-sm md:text-base font-medium text-global-text-muted">
                  {role}
                </span>
              )}
            </div>

            {modality && (
              <div class="flex items-center justify-center gap-2 flex-wrap">
                {modality.includes("T") && (
                  <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-200">
                    Teoría
                  </span>
                )}
                {modality.includes("P") && (
                  <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full dark:bg-green-900 dark:text-green-200">
                    Práctica
                  </span>
                )}
                {modality.includes("L") && (
                  <span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full dark:bg-purple-900 dark:text-purple-200">
                    Lab
                  </span>
                )}
              </div>
            )}
          </div>
        )}
      </div>

      <div
        class="flex items-center gap-2"
        aria-label={`Calificación: ${safeRating} de 5`}
      >
        {ratingStyle === "stars"
          ? stars.map((_, i) => (
              <IconStar
                size={18}
                filled={i < safeRating}
                class="text-global-primary"
              />
            ))
          : stars.map((_, i) => (
              <span
                class={
                  i < safeRating
                    ? "block h-3.5 w-3.5 rounded-sm bg-global-primary"
                    : "block h-3.5 w-3.5 rounded-sm border border-global-border"
                }
              />
            ))}
      </div>

      <div class="pt-2">
        {openId ? (
          <button
            id={openId}
            class="inline-flex items-center justify-center rounded-2xl bg-global-primary hover:bg-global-primary-hover px-4 py-2 text-[15px] font-semibold text-global-text focus:outline-none focus-visible:ring-2 focus-visible:ring-[#51A624]"
          >
            {buttonLabel}
          </button>
        ) : showButton ? (
          <span class="inline-flex cursor-default items-center justify-center rounded-2xl bg-global-primary px-4 py-2 text-[15px] font-semibold text-global-text opacity-70">
            {buttonLabel}
          </span>
        ) : null}
      </div>
    </div>
  )
}
