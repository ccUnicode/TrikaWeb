---
import type { SheetSummary } from "../lib/data";

/* 1. Definimos las "props" (las variables) que la tarjeta va a recibir */
export interface Props {
  sheet?: SheetSummary;
  ciclo?: string;
  profesor?: string;
  tieneSolucion?: boolean;
  evaluacion?: string;
  href?: string;
}
const { sheet, ciclo, profesor, tieneSolucion, evaluacion, href } =
  Astro.props as Props;

const courseLabel =
  sheet?.course_name ?? sheet?.course_code ?? profesor ?? "Curso";
const cycleLabel = sheet?.cycle ?? ciclo ?? "Sin ciclo";
const examLabel = sheet?.exam_type ?? evaluacion ?? "";
const hasSolution = sheet
  ? Boolean(sheet.solution_kind)
  : Boolean(tieneSolucion);
const resolvedHref = sheet ? `/exams/${sheet.id}` : (href ?? "#");

/* 2. Definimos los iconos (los metemos aqui) */
const checkIcon = `
<span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-global-primary">
  <span class="block h-1.5 w-2.5 rounded-sm border-b-[3px] border-l-[3px] border-global-text" style="transform: rotate(-45deg) translate(-1px, -1px);"></span>
</span>
`;
const noCheckIcon = `
<span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-global-border">
  <span class="block h-0.5 w-2.5 rounded-full bg-white/50"></span>
</span>
`;
---

<div class="relative transition-transform hover:scale-105" data-fav-card>
  <button
    type="button"
    class="absolute right-3 top-3 z-10 inline-flex h-8 w-8 items-center justify-center text-white/80 hover:text-global-primary transition"
    data-fav-btn
    data-sheet-id={sheet?.id}
    aria-label="Guardar plancha"
    aria-pressed="false"
  >
    <svg class="h-6 w-6 drop-shadow-md" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
    </svg>
    {/*
    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M6 4h12a1 1 0 0 1 1 1v15l-7-4-7 4V5a1 1 0 0 1 1-1z" />
    </svg>
    */}
  </button>

  <a
    href={resolvedHref}
    class="flex w-full h-auto flex-col gap-2 rounded-lg bg-global-card p-4 shadow-lg"
  >
    <div class="w-full aspect-[3/2] rounded bg-global-bg mb-4"></div>

    <div class="flex items-center pr-2 justify-between -mt-2">
      <span class="text-base md:text-lg font-semibold text-global-text">{courseLabel}</span>

      {
        hasSolution ? (
          <Fragment set:html={checkIcon} />
        ) : (
          <Fragment set:html={noCheckIcon} />
        )
      }
    </div>
    {
      examLabel ? (
        <div class="flex items-center justify-between gap-2 pr-2 text-sm md:text-base">
          <span class="font-semibold text-global-text-muted">{examLabel}</span>
          <span class="text-global-text-muted">{cycleLabel}</span>
        </div>
      ) : (
        <span class="text-sm md:text-base font-medium text-global-text-muted">{cycleLabel}</span>
      )
    }
  </a>
</div>

<script lang="ts">
  import { isFavorite, toggleFavorite } from "../lib/favorites";

  const activeClasses = ["text-red-500", "border-transparent"];
  const inactiveClasses = [
    "bg-global-card/80",
    "text-white/70",
    "border-transparent",
    "hover:border-global-primary",
    "hover:text-global-primary",
  ];

  function updateButton(btn: HTMLElement) {
    const id = Number(btn.dataset.sheetId);
    if (!Number.isInteger(id)) return;
    const isFav = isFavorite(id);
    btn.setAttribute("aria-pressed", String(isFav));

    activeClasses.forEach(cls => btn.classList.toggle(cls, isFav));
    inactiveClasses.forEach(cls => btn.classList.toggle(cls, !isFav));

    const svg = btn.querySelector("svg");
    if (isFav) {
      svg?.setAttribute("fill", "currentColor");
    } else {
      svg?.setAttribute("fill", "none");
    }
  }

  function initFavorites() {
    const buttons = Array.from(document.querySelectorAll<HTMLElement>("[data-fav-btn]"));
    buttons.forEach(updateButton);

    buttons.forEach(btn => {
      btn.addEventListener("click", e => {
        const id = Number(btn.dataset.sheetId);
        if (!Number.isInteger(id)) return;
        e.preventDefault();
        e.stopPropagation();
        toggleFavorite(id);
        updateButton(btn);
      });
    });

    window.addEventListener("favorites:updated", () => {
      buttons.forEach(updateButton);
    });
  }

  // Run on load and after Astro swaps
  document.addEventListener("astro:page-load", initFavorites);
  document.addEventListener("DOMContentLoaded", initFavorites);
</script>
