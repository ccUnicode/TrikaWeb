---
import type { SheetSummary } from "../lib/data";

/* 1. Definimos las "props" (las variables) que la tarjeta va a recibir */
export interface Props {
  sheet?: SheetSummary;
  ciclo?: string;
  profesor?: string;
  tieneSolucion?: boolean;
  evaluacion?: string;
  href?: string;
}
const { sheet, ciclo, profesor, tieneSolucion, evaluacion, href } =
  Astro.props as Props;

const courseLabel =
  sheet?.course_name ?? sheet?.course_code ?? profesor ?? "Curso";
const cycleLabel = sheet?.cycle ?? ciclo ?? "Sin ciclo";
const examLabel = sheet?.exam_type ?? evaluacion ?? "";
const hasSolution = sheet
  ? Boolean(sheet.solution_kind)
  : Boolean(tieneSolucion);
const resolvedHref = sheet ? `/exams/${sheet.id}` : (href ?? "#");

/* 2. Definimos los iconos (los metemos aqui) */
const checkIcon = `
<span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-global-primary">
  <span class="block h-1.5 w-2.5 rounded-sm border-b-[3px] border-l-[3px] border-global-text" style="transform: rotate(-45deg) translate(-1px, -1px);"></span>
</span>
`;
const noCheckIcon = `
<span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-global-border">
  <span class="block h-0.5 w-2.5 rounded-full bg-white/50"></span>
</span>
`;
---

<a
  href={resolvedHref}
  class="flex w-full h-auto flex-col gap-2 rounded-lg bg-global-card p-4 shadow-lg transition-transform hover:scale-105"
>
  <div class="w-full aspect-[3/2] rounded bg-global-bg mb-4 relative">
    <button
      class="absolute top-2 right-2 z-10 p-2 text-white/70 hover:scale-110 transition"
      data-favorite-btn
      data-sheet-id={sheet?.id}
      aria-label="Guardar en favoritos"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="drop-shadow-md"
      >
        <path
          d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"
        ></path>
      </svg>
    </button>
  </div>

  <div class="flex items-center pr-2 justify-between -mt-2">
    <span class="text-base md:text-lg font-semibold text-global-text"
      >{courseLabel}</span
    >

    {
      hasSolution ? (
        <Fragment set:html={checkIcon} />
      ) : (
        <Fragment set:html={noCheckIcon} />
      )
    }
  </div>
  {
    examLabel ? (
      <div class="flex items-center justify-between gap-2 pr-2 text-sm md:text-base">
        <span class="font-semibold text-global-text-muted">{examLabel}</span>
        <span class="text-global-text-muted">{cycleLabel}</span>
      </div>
    ) : (
      <span class="text-sm md:text-base font-medium text-global-text-muted">
        {cycleLabel}
      </span>
    )
  }
</a>

<script>
  import { isFavorite, toggleFavorite } from "../lib/favorites";

  function initFavorites() {
    const btns = document.querySelectorAll("[data-favorite-btn]");
    btns.forEach((btn) => {
      if (btn instanceof HTMLElement) {
        const id = Number(btn.dataset.sheetId);
        if (!id) return; // Don't attach if no ID (e.g. skeleton)

        const updateState = () => {
          const active = isFavorite(id);
          const svg = btn.querySelector("svg");
          if (active) {
            svg?.setAttribute("fill", "currentColor");
            btn.classList.add("text-red-500");
            btn.classList.remove("text-white/70");
          } else {
            svg?.setAttribute("fill", "none");
            btn.classList.remove("text-red-500");
            btn.classList.add("text-white/70");
          }
        };

        // Initial state
        updateState();

        // Click handler
        btn.addEventListener("click", (e) => {
          e.preventDefault(); // Prevent link navigation
          e.stopPropagation();
          toggleFavorite(id);
          updateState();
        });
      }
    });
  }

  // Run on load and after Astro swaps
  document.addEventListener("astro:page-load", initFavorites);
  document.addEventListener("DOMContentLoaded", initFavorites);
</script>
