---
import type { SheetSummary } from "../lib/data";
import { supabaseAdmin } from "../lib/supabaseAdmin";

/* 1. Definimos las "props" (las variables) que la tarjeta va a recibir */
export interface Props {
  sheet?: SheetSummary;
  ciclo?: string;
  profesor?: string;
  tieneSolucion?: boolean;
  evaluacion?: string;
  href?: string;
}
const { sheet, ciclo, profesor, tieneSolucion, evaluacion, href } =
  Astro.props as Props;

const courseLabel =
  sheet?.course_name ?? sheet?.course_code ?? profesor ?? "Curso";
const cycleLabel = sheet?.cycle ?? ciclo ?? "Sin ciclo";
const examLabel = sheet?.exam_type ?? evaluacion ?? "";
const hasSolution = sheet
  ? Boolean(sheet.solution_kind)
  : Boolean(tieneSolucion);
const resolvedHref = sheet ? `/exams/${sheet.id}` : (href ?? "#");

let thumbUrl: string | null = null;
if (sheet?.thumb_storage_path) {
  try {
    // Fix: Remove "thumbnails/" prefix if present in the database path
    // The createSignedUrl method expects a path relative to the bucket, not including the bucket name.
    const storagePath = sheet.thumb_storage_path.startsWith("thumbnails/")
      ? sheet.thumb_storage_path.replace("thumbnails/", "")
      : sheet.thumb_storage_path;

    const supa = supabaseAdmin;
    const { data } = await supa.storage
      .from("thumbnails")
      .createSignedUrl(storagePath, 3600);
    thumbUrl = data?.signedUrl ?? null;
  } catch (error) {
    console.error("Error signing thumb url:", error);
  }
}

/* 2. Definimos los iconos (los metemos aqui) */
const checkIcon = `
<div class="group relative flex items-center justify-center">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 text-green-500">
    <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
  </svg>
  <span class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap shadow-lg z-20">
    Tiene solucionario
  </span>
</div>
`;
const noCheckIcon = `
<div class="group relative flex items-center justify-center">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 text-gray-500">
    <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm3 10.5a.75.75 0 000-1.5H9a.75.75 0 000 1.5h6z" clip-rule="evenodd" />
  </svg>
  <span class="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap shadow-lg z-20">
    No tiene solucionario
  </span>
</div>
`;
---

<div
  class="relative transition-transform hover:scale-105 isolate"
  data-fav-card
>
  <button
    type="button"
    class="absolute right-3 top-3 z-50 inline-flex h-8 w-8 items-center justify-center rounded-full bg-black/20 text-white/80 backdrop-blur-sm transition hover:scale-110 hover:bg-black/40 hover:text-global-primary cursor-pointer"
    data-fav-btn
    data-sheet-id={sheet?.id}
    aria-label="Guardar plancha"
    aria-pressed="false"
  >
    <svg
      class="h-6 w-6 drop-shadow-md"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path
        d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"
      ></path>
    </svg>
  </button>

  <a
    href={resolvedHref}
    class="flex w-full h-auto flex-col gap-2 rounded-lg bg-global-card p-4 shadow-lg"
  >
    {
      thumbUrl ? (
        <img
          src={thumbUrl}
          alt={`Miniatura de ${courseLabel}`}
          class="w-full aspect-3/2 rounded object-cover object-top mb-4 bg-global-bg"
          loading="lazy"
        />
      ) : (
        <div class="w-full aspect-3/2 rounded bg-global-bg mb-4" />
      )
    }

    <div class="flex items-center pr-2 justify-between -mt-2">
      <span class="text-base md:text-lg font-semibold text-global-text"
        >{courseLabel}</span
      >

      {
        hasSolution ? (
          <Fragment set:html={checkIcon} />
        ) : (
          <Fragment set:html={noCheckIcon} />
        )
      }
    </div>
    {
      examLabel ? (
        <div class="flex items-center justify-between gap-2 pr-2 text-sm md:text-base">
          <span class="font-semibold text-global-text-muted">{examLabel}</span>
          <span class="text-global-text-muted">{cycleLabel}</span>
        </div>
      ) : (
        <span class="text-sm md:text-base font-medium text-global-text-muted">
          {cycleLabel}
        </span>
      )
    }
  </a>
</div>

<script>
  import { isFavorite, toggleFavorite } from "../lib/favorites";

  // Updates the visual state of a button
  function updateButtonState(btn: Element) {
    if (!(btn instanceof HTMLElement)) return;
    const id = Number(btn.dataset.sheetId);
    if (!Number.isInteger(id)) return;

    const isFav = isFavorite(id);
    btn.setAttribute("aria-pressed", String(isFav));

    // Toggle classes
    if (isFav) {
      btn.classList.add("text-red-500", "scale-110");
      btn.classList.remove("text-white/80");
    } else {
      btn.classList.remove("text-red-500", "scale-110");
      btn.classList.add("text-white/80");
    }

    const svg = btn.querySelector("svg");
    if (svg) {
      svg.setAttribute("fill", isFav ? "currentColor" : "none");
      svg.setAttribute("stroke", isFav ? "currentColor" : "currentColor");
    }
  }

  // Setup listeners
  function setupFavorites() {
    const buttons = document.querySelectorAll("[data-fav-btn]");

    buttons.forEach((btn) => {
      // Update initial state
      updateButtonState(btn);

      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation(); // Stop bubbling to card link

        const target = e.currentTarget as HTMLElement;
        const id = Number(target.dataset.sheetId);

        if (Number.isInteger(id)) {
          toggleFavorite(id);
          // State update happens via event listener below
        }
      });
    });
  }

  // Listen for storage/toggle updates
  window.addEventListener("favorites:updated", () => {
    document.querySelectorAll("[data-fav-btn]").forEach(updateButtonState);
  });

  // Init on load
  document.addEventListener("astro:page-load", setupFavorites);
  // Also on DOMContentLoaded for first load if ViewTransitions not active immediately
  document.addEventListener("DOMContentLoaded", setupFavorites);
</script>
