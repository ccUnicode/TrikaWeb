---
export interface Props {
  sheetId: number | string;
  initialAvg?: number;
  initialCount?: number;
}
const { sheetId, initialAvg = 0, initialCount = 0 } = Astro.props as Props;
---
<div class="rating-component" data-sheet-id={sheetId}>
  <div class="stars" role="radiogroup" aria-label="Valoración" style="display:flex;gap:6px;">
    {Array.from({ length: 5 }).map((_, i) => (
      <button type="button" class="star-btn" data-value={i + 1} aria-label={`Votar ${i + 1}`}>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"/></svg>
      </button>
    ))}
  </div>
  <div class="meta" style="font-size:12px;color:var(--muted,#6b7280);margin-top:6px;">
    <span class="avg">{initialAvg.toFixed(2)}</span> · <span class="count">{initialCount}</span> votos
  </div>
</div>

<script is:inline type="module">
  import { getOrCreateDeviceId } from '/src/lib/clientUtils.js';

  (function initRating() {
    const root = document.currentScript?.previousElementSibling || document.querySelector('.rating-component[data-sheet-id]');
    if (!root) return;
    const id = root.dataset.sheetId;
    const stars = Array.from(root.querySelectorAll('.star-btn'));
    const avgEl = root.querySelector('.avg');
    const countEl = root.querySelector('.count');

    stars.forEach((btn) => {
      btn.addEventListener('click', async () => {
        const score = Number(btn.dataset.value);
        const deviceId = getOrCreateDeviceId();
        try {
          const res = await fetch(`/api/sheets/${id}/rate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_id: deviceId, score })
          });
          const data = await res.json();
          if (res.ok && data?.stats) {
            avgEl.textContent = Number(data.stats.avg_difficulty || 0).toFixed(2);
            countEl.textContent = String(data.stats.rating_count || 0);
            stars.forEach((s, i) => s.classList.toggle('filled', i < score));
          } else {
            console.error('Rate error', data);
            alert(data?.error || 'Error al votar');
          }
        } catch (e) { console.error(e); }
      });
    });
  })();
</script>

<style>
  .star-btn{ background:transparent;border:0;cursor:pointer;color:#f6c744;opacity:.98;padding:2px;display:inline-flex;align-items:center; }
  .star-btn.filled svg{ filter: drop-shadow(0 0 6px rgba(246,199,68,.25)); }
  .meta{ font-size:12px;color:var(--muted,#6b7280); margin-top:4px;}
</style>